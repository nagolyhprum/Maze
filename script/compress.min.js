var Tween=function(){function e(){this.queue=[],this.locked=0}function t(e,t){return setCatchup(e,t)}return e.prototype.push=function(e){return this.queue.push(e),this.process()},e.prototype.clear=function(){for(var e=0;e<this.queue.length;e++)this.queue[e].isCleared=!0;return this},e.prototype.process=function(){var e=this;if(!e.locked&&e.queue.length){e.locked=1;var n=e.queue[0],r=t(function(){if(n.isCleared||n.change()===!1)r&&clearInterval(r),e.queue.shift(),n.complete&&n.complete(),e.locked=0,e.process()},n.isCleared?0:n.interval);n.init&&n.init()}return e},e.prototype.isTweening=function(){return this.locked},e}();var MazeGenerator=function(){function e(e,t,n){var r=[],i=t*e;for(var s=0;s<i;s++)r[s%e+Math.floor(s/e)*t]=n;return r}function t(e,t){this.columns=e,this.rows=t}function n(){}return t.prototype.hasVisited=function(e,t,n){return e[t+n*e.columns]},t.prototype.visit=function(e,t,n){return e[t+n*e.columns]=1,this},t.prototype.generateMaze=function(){var n=[];n.columns=this.columns;var r=e(this.columns,this.rows,t.walls.all);r.columns=this.columns,r.rows=this.rows;var i=[this.generateCell(Math.floor(Math.random()*this.columns),Math.floor(Math.random()*this.rows))];this.visit(n,i[0].column,i[0].row);while(i.length){var s=i[i.length-1],o=s.directions.splice(Math.floor(Math.random()*s.directions.length),1)[0];o?this.hasVisited(n,o.column,o.row)||(i.push(this.generateCell(o.column,o.row)),this.visit(n,o.column,o.row),r[s.column+s.row*this.columns]^=o.remove.current,r[o.column+o.row*this.columns]^=o.remove.other):i.pop()}return r},t.prototype.generateCell=function(e,n,r){r=r||[];var i=[],s=r.columns||this.columns,o=r.rows||this.rows;return n>0&&!(r&&r[e+n*s]&t.walls.top)&&i.push({column:e,row:n-1,remove:{current:t.walls.top,other:t.walls.bottom}}),e+1<s&&!(r&&r[e+n*s]&t.walls.right)&&i.push({column:e+1,row:n,remove:{current:t.walls.right,other:t.walls.left}}),n+1<o&&!(r&&r[e+n*s]&t.walls.bottom)&&i.push({column:e,row:n+1,remove:{current:t.walls.bottom,other:t.walls.top}}),e>0&&!(r&&r[e+n*s]&t.walls.left)&&i.push({column:e-1,row:n,remove:{current:t.walls.left,other:t.walls.right}}),{column:e,row:n,directions:i,weight:1,compareTo:function(e){return this.weight-e.weight}}},t.prototype.generateDomElement=function(e,n,r){var i="<div id='"+r+"' class='maze' style='border:1px solid black;float:left;width:"+(e.columns*n+e.columns*2)+"px;height:"+(e.rows*n+e.rows*2)+"px;'>";for(var s=0;s<e.length;s++){s%e.columns===0&&(i+="<div style='clear:both;'></div>");var o="";for(var u in t.walls)u!=="all"&&(e[s]&t.walls[u]?o+="border-"+u+":1px solid black;":o+="padding-"+u+":1px;");i+="<div class='cell' style='width:"+n+"px;height:"+n+"px;float:left;"+o+"'></div>"}return i+"</div>"},t.walls={top:1,right:2,bottom:4,left:8,all:15},t.prototype.getPath=function(e,t,r,i,s){var o=[];o.columns=e.columns;var u=new n,a=this.generateCell(t,r,e),f=[];a.parent=null,a.length=0,a.weight=this.heuristics(t,r,i,s),u.queue(a);while(u.length&&!f.length){var l=u.dequeue();this.visit(o,l.column,l.row);if(l.column===i&&l.row===s)while(l)f.push(l),l=l.parent;else for(var c=0;c<l.directions.length;c++){var h=l.directions[c];this.hasVisited(o,h.column,h.row)||(a=this.generateCell(h.column,h.row,e),a.length=l.length+1,a.weight=a.length+this.heuristics(a.column,a.row,i,s),a.parent=l,u.queue(a))}}return f},t.prototype.heuristics=function(e,t,n,r){return Math.abs(e-n)+Math.abs(t-r)},n.prototype=new Array,n.prototype.queue=function(e){var t=this.push(e)-1,n=Math.floor((t+1)/2)-1;while(n>=0&&this[n].compareTo(this[t])>0)this.swap(n,t),t=n,n=Math.floor((t+1)/2)-1;return this},n.prototype.swap=function(e,t){var n=this[e];this[e]=this[t],this[t]=n},n.prototype.dequeue=function(){var e=this.shift(),t=0,n,r=this.pop();if(r){this.unshift(r);var i=this[t*2+1],s=this[t*2+2];while(i!==undefined&&r.compareTo(i)>0||s!==undefined&&r.compareTo(s)>0)i!==undefined&&r.compareTo(i)>0&&s!==undefined&&r.compareTo(s)>0?i.compareTo(s)<0?n=t*2+1:n=t*2+2:i!==undefined&&r.compareTo(i)>0?n=t*2+1:s!==undefined&&r.compareTo(s)>0&&(n=t*2+2),this.swap(n,t),t=n,i=this[t*2+1],s=this[t*2+2]}return e},t}();var EventHandler=function(){function e(e){this.events={};if(e&&e.events)for(var t in e.events)this.events[t]=e.events[t].slice(0)}return e.prototype.invoke=function(e,t){t=t instanceof Array?t:[t];var n=this.events[e];if(!n)return this;for(var r=0;r<n.length;r++)n[r].apply(undefined,t);return this},e.prototype.attach=function(e,t){return(this.events[e]=this.events[e]||[]).push(t),this},e.prototype.detach=function(e,t){var n=this.events[e];if(!n)return this;for(var r=0;r<n.length;r++)if(n[r]===t){n.splice(r,1);break}return this},e}();function getDrawingOrder(e){return{legs:10,feet:11,chest:12,hands:13,head:14,mainhand:15,offhand:16}[e]}function unequip(e,t){var n=equipment_items[e].item;if(t!==-1){if(n!==undefined){var r=Statistics.getStatisticNames();for(var i=0;i<r.length;i++){var s=r[i];character.statistics[s].current-=n.statistics[s].current,character.statistics[s].max-=n.statistics[s].max}var o=getDrawingOrder(e);character.slash[o]=undefined,character.walk[o]=undefined,character.bow[o]=undefined,character.spellcast[o]=undefined,character.thrust[o]=undefined,character.hurt[o]=undefined,inventory_items[t]=n,Sound.effect(n.sounds.move),equipment_items[e].item=undefined}}else alert("You have no room in your inventory for this item.")}function equip(e,t){var n=Statistics.getStatisticNames();for(var r=0;r<n.length;r++){var i=n[r];character.statistics[i].current+=e.statistics[i].current,character.statistics[i].max+=e.statistics[i].max}var s=getDrawingOrder(e.weight===1&&e.type==="mainhand"?"offhand":e.type);e.slash&&(character.slash[s]=e.slash),e.walk&&(character.walk[s]=e.walk),e.bow&&(character.bow[s]=e.bow),e.spellcast&&(character.spellcast[s]=e.spellcast),e.thrust&&(character.thrust[s]=e.thrust),e.hurt&&(character.hurt[s]=e.hurt),inventory_items[inventory_items.indexOf(e)]=undefined,equipment_items[t].item=e,Sound.effect(e.sounds.move)}function attachEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}function detachEvent(e,t,n){e.addEventListener?e.removeEventListener(t,n,!1):e.detachEvent?e.detachEvent("on"+t,n):e["on"+t]=null}function clamp(e,t,n){return Math.min(Math.max(e,t),n)}function TileSet(e){var t=this;e=e||{},t.rows=e.rows||1,t.columns=e.columns||1,e.location=e.location||{},t.location={row:e.location.row||0,column:e.location.column||0,x:e.location.x||0,y:e.location.y||0},e.display=e.display||{},t.display={row:e.display.row||0,column:e.display.column||0},t.src=e.src,this.image=loadImage(e.src,function(e){t.width=e.width/t.columns,t.height=e.height/t.rows,t.complete=1})}function getSign(e){return e?e/Math.abs(e):0}function Character(e){this.tween=new Tween,e=e||{},this.events=new EventHandler,this.attackstyle=e.attackstyle||"slash",this.walk=e.walk||[],this.bow=e.bow||[],this.spellcast=e.spellcast||[],this.thrust=e.thrust||[],this.slash=e.slash||[],this.hurt=e.hurt||[],this.active=this.walk,this.id=e.id,this.name=e.name,this.portrait=loadImage(e.portrait),e.location=e.location||{},this.location={column:e.location.column||0,row:e.location.row||0,x:e.location.x||0,y:e.location.y||0},e.display=e.display||{},this.display={row:e.display.row||0,column:e.display.column||0},this.statistics=new Statistics(e.statistics),e.sounds=e.sounds||{},this.sounds={slash:e.sounds.slash||[],hurt:e.sounds.hurt||[]}}function Item(e){e=e||{},e.location=e.location||{},e.walk&&(this.walk=new TileSet(e.walk)),e.spellcast&&(this.spellcast=new TileSet(e.spellcast)),e.bow&&(this.bow=new TileSet(e.bow)),e.slash&&(this.slash=new TileSet(e.slash)),e.thrust&&(this.thrust=new TileSet(e.thrust)),this.attack=e.attack||"slash",this.location={row:e.location.row||0,column:e.location.column||0,x:e.location.x||0,y:e.location.y||0},this.weight=e.weight||0,this.type=e.type,this.portrait=loadImage(e.portrait),this.statistics=new Statistics(e.statistics),this.id=e.id,this.name=e.name,e.sounds=e.sounds||{},this.sounds={move:e.sounds.move||[]}}function generateText(e){var t=document.createElement("canvas"),n=t.getContext("2d"),r=0,i=0;text=e.text.split("\n");while(r<text.length){var s=n.measureText(text[r]).width,o=0;while(s>e.width){var u=text[r],a=u.lastIndexOf(" ");if(a===-1)break;var f=u.substring(a+1),l=u.substring(0,a);text[r]=l,o>0?text[r+1]=f+" "+text[r+1]:text.splice(r+1,0,f),o++,s=n.measureText(l).width}r++,s>i&&(i=s)}var c=e.font||n.font,h=parseInt(c);t.width=i,t.height=text.length*h+h/3,n.font=c,n.fillStyle=e.color||"black",n.textBaseline="top",n.textAlign="left";for(var p=0;p<text.length;p++)n.fillText(text[p],0,p*h,e.width);return t}String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var Sound=function(){var e=new Audio,t=[],n={},r={};return e.canPlayType&&(e.canPlayType("audio/mpeg;").replace("no","")&&t.push(".mp3"),e.canPlayType("audio/wav;").replace("no","")&&t.push(".wav"),e.canPlayType("audio/ogg;").replace("no","")&&t.push(".ogg")),r.effect=function(e,i){var s=n[e];s||(s=n[e]=[]);var o,u=0;for(var a=0;a<s.length&&!o;a++)s[a].paused&&s[a].canplay&&(o=s[a]);o?o.play():(o=new Audio,o.autoplay=!0,s.push(o),attachEvent(o,"canplaythrough",function(){this.canplay=!0}),o.src=r.root+e+t[u],u+=1,attachEvent(o,"error",function(){u<t.length&&(o.src=r.root+e+t[u],u+=1)}));var f=function(){i&&i(),detachEvent(this,"ended",f)};return attachEvent(o,"ended",f),function(){o.autoplay=!1,o.pause()}},r.music=function(e){var t,n=function(){t=Sound.effect(e,n)};return n(),function(){t()}},r.root="./",r}();Sound.root="audio/",Sound.music("music/dungeon");var loadImage=function(){var e={},t={};return function(n,r){n=loadImage.root+n;var i=e[n],s=t[n];return i||(i=e[n]=new Image,i.src=n),r&&(i.complete?r(i):s?s.attach("load",r):(s=t[n]=new EventHandler,s.attach("load",r),attachEvent(i,"load",function(){t[n].invoke("load",[i])}))),i}}();loadImage.root="images/",TileSet.prototype.draw=function(e,t,n,r,i){e.drawImage(this.image,this.display.column*this.width,this.display.row*this.height,this.width,this.height,t,n,r,i)};var $=function(){function t(){return document.body&&document.body.readyState==="complete"}function n(n){var r=typeof n;return r==="function"?t()?(n(),!0):(e.attach("load",n),!1):r==="string"?document.querySelectorAll(n):!1}var e=new EventHandler;return t()?e.invoke("load"):attachEvent(window,"load",function(){e.invoke("load")}),n}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),Statistics=function(){var e=["health","energy","experience","strength","defense","speed"],t=function(t){t=t||{};for(var n=0;n<e.length;n++){var r=e[n];t[r]=t[r]||{},this[r]={max:t[r].max||0,current:t[r].current||0}}this._add=[],this._multiply=[]};return t.getStatisticNames=function(){return e},t.prototype.getMax=function(e){var t=this[e].max,n=0;for(;n<this._add.length;n++)t+=this._add[n][e].max;for(n=0;n<this._multiply.length;n++)t+=t*this._multiply[n][e].max;return t},t.prototype.getCurrent=function(e){var t=this[e].max,n=0;for(;n<this._add.length;n++)t+=this._add[n][e].max;for(n=0;n<this._multiply.length;n++)t+=t*this._multiply[n][e].max;return t},t.prototype.add=function(e){this._add.push(e)},t.prototype.multiply=function(e){this._multiply.push(e)},t}();Character.prototype.draw=function(e){for(var t=0;t<this.active.length;t++){var n=this.active[t];n&&n.complete&&e.drawImage(n.image,this.display.column*n.width,this.display.row*n.height,n.width,n.height,CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+this.location.x,CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.HEIGHT+this.location.y,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}};var SPEED=150,SLEEP=500;Character.prototype.timeToMove=function(){return Math.ceil(SPEED/this.statistics.speed.current*CONSTANTS.TILE.WIDTH)+SLEEP},Character.prototype.moves=function(){var e=(new Date).getTime(),t=this.timeToMove(),n;return this.elapsedTime+=e-this.lastTime,this.lastTime=e,n=Math.floor(this.elapsedTime/t),this.elapsedTime=this.elapsedTime%t,n};var WALK=["sound/walk/stepstone_1","sound/walk/stepstone_2","sound/walk/stepstone_3","sound/walk/stepstone_4","sound/walk/stepstone_5","sound/walk/stepstone_6","sound/walk/stepstone_7","sound/walk/stepstone_8"];Character.prototype.moveBy=function(e,t,n){var r=this;Sound.effect(WALK[Math.floor(WALK.length*Math.random())]),this.tween.push({init:function(){r.location.x=-e,r.location.y=-t},change:function(){return r.location.x+=getSign(e),r.location.y+=getSign(t),r.display.column=Math.max((r.display.column+1)%r.active[0].columns,1),Math.abs(r.location.x)+Math.abs(r.location.y)!==0},interval:SPEED/this.statistics.speed.current,complete:function(){r.display.column=r.location.x=r.location.y=0,setTimeout(n,SLEEP)}})},Character.prototype.attack=function(e){var t=this,n=-1;Sound.effect(this.sounds.slash[Math.floor(this.sounds.slash.length*Math.random())]),this.tween.push({init:function(){t.display.column=0,t.active=t[t===character&&equipment_items.mainhand.item?equipment_items.mainhand.item.attack:t.attackstyle]},change:function(){return n++,t.display.column=Math.floor(n/CONSTANTS.TILE.WIDTH*t.active[0].columns),n!==CONSTANTS.TILE.WIDTH},interval:SPEED/this.statistics.speed.current,complete:function(){t.active=t.walk,t.display.column=0,setTimeout(e,SLEEP)}})},Character.prototype.face=function(e,t){Math.abs(this.location.column-e)>Math.abs(this.location.row-t)?this.location.column>e?this.display.row=CONSTANTS.DIRECTION.LEFT:this.location.column<e&&(this.display.row=CONSTANTS.DIRECTION.RIGHT):this.location.row>t?this.display.row=CONSTANTS.DIRECTION.UP:this.location.row<t&&(this.display.row=CONSTANTS.DIRECTION.DOWN)};var BLOOD=["sound/blood/blood1","sound/blood/blood2","sound/blood/blood3","sound/blood/blood4"];Character.prototype.damage=function(e,t,n){var r=this.statistics.health;if(r.current>0){Sound.effect(BLOOD[Math.floor(BLOOD.length*Math.random())]),new Blood({location:{x:CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.WIDTH/2,y:CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.HEIGHT/2}}),Sound.effect(this.sounds.hurt[Math.floor(this.sounds.hurt.length*Math.random())]),r.current-=e;if(r.current<=0){var i=this;t&&t.call(this),this.die(n)}}},Character.prototype.die=function(e){var t=this;this.tween.push({init:function(){t.active=t.hurt,t.display={row:0,column:0}},change:function(){return t.display.column=t.display.column+1,t.display.column!==t.active[0].columns},interval:100,complete:function(){e&&e.call(t)}})},Character.prototype.wait=function(e){this.tween.push({change:function(){return!1},interval:10,complete:e})};var Server=function(){function o(e,t){var n=Math.random();return n>.5?f(e,t):n>=0?a(e,t):u(e,t)}function u(e,t){return f(e,t)}function a(e,t){var n=[{portrait:"buckler",weight:1,strength:0,defense:5,speed:0,name:"Buckler",walk:{src:"walk/WEAPON_shield_cutout_body.png",rows:4,columns:9}},{attack:"slash",portrait:"dagger",weight:2,strength:5,defense:0,speed:0,name:"Dagger",slash:{src:"slash/WEAPON_dagger.png",rows:4,columns:6}},{attack:"bow",portrait:"shortbow",weight:3,strength:3,defense:0,speed:3,name:"Short Bow",bow:{src:"bow/WEAPON_bow.png",rows:4,columns:13}},{attack:"spellcast",portrait:"wand",weight:2,strength:0,defense:0,speed:0,energy:5,name:"Wand",spellcast:{src:"spellcast/HEAD_skeleton_eye_glow.png",rows:4,columns:6}},{attack:"thrust",portrait:"longsword",weight:4,strength:10,defense:0,speed:0,energy:0,name:"Long Sword",thrust:{src:"thrust/WEAPON_spear.png",rows:4,columns:8}}],r=n[Math.floor(Math.random()*n.length)];return new Item({attack:r.attack,name:r.name,sounds:{move:["sound/inventory/coin"]},slash:r.slash,walk:r.walk,thrust:r.thrust,bow:r.bow,spellcast:r.spellcast,weight:r.weight,type:"mainhand",portrait:"items/"+r.portrait+".png",id:1,location:{column:e,row:t},statistics:{strength:{current:r.strength,max:r.strength},defense:{current:r.defense,max:r.defense},speed:{current:r.speed,max:r.speed},energy:{current:r.energy,max:r.energy}}})}function f(e,t){var n=["cloth","hide","leather","chain","steel"],r=["head","feet","hands","legs","chest"],i=["cloth","head"];while(i[0]==="cloth"&&i[1]==="head")i[2]=Math.floor(Math.random()*n.length),i[0]=n[i[2]],i[1]=r[Math.floor(Math.random()*r.length)];return new Item({slash:{src:"slash/"+i[1]+".png",rows:4,columns:6},walk:{src:"walk/"+i[1]+".png",rows:4,columns:9},thrust:{src:"thrust/"+i[1]+".png",rows:4,columns:8},bow:{src:"bow/"+i[1]+".png",rows:4,columns:13},spellcast:{src:"spellcast/"+i[1]+".png",rows:4,columns:7},name:i[0]+" "+i[1],sounds:{move:["sound/inventory/coin"]},type:i[1],portrait:"items/"+i[0]+"-"+i[1]+".png",id:1,location:{column:e,row:t},statistics:{strength:{current:i[2],max:i[2]},defense:{current:i[2],max:i[2]},speed:{current:i[2],max:i[2]}}})}var e={};e.getTiles=function(){var e=[],t;for(var n=0;n<CONSTANTS.TILE.ROWS;n++){e.push(t=[]);for(var r=0;r<CONSTANTS.TILE.COLUMNS;r++)t.push({row:11,column:0})}return e};var t=5,n=5,r=new MazeGenerator(n,t),i=r.generateMaze();e.getWalls=function(){return i[room.location.row*n+room.location.column]},e.getAllWalls=function(){var e=[];for(var r=0;r<i.length;r++)e[r]=undefined;return{data:e,rows:t,columns:n}},e.getCharacterRoomLocation=function(){return{row:0,column:0}},e.getCharacter=function(){return new Character({portrait:"face/FlareMaleHero1.png",attackstyle:"slash",name:"Logan",sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],bow:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],thrust:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/grunts/grunt1","sound/grunts/grunt2","sound/grunts/grunt3","sound/grunts/grunt4","sound/grunts/grunt5","sound/grunts/grunt6","sound/grunts/grunt7","sound/grunts/grunt8","sound/grunts/grunt9","sound/grunts/grunt10","sound/grunts/grunt11"]},statistics:{health:{max:50,current:50},speed:{current:25,max:25},experience:{current:0,max:100}},display:{row:2},walk:[new TileSet({columns:9,rows:4,src:"walk/BODY_male.png"}),new TileSet({columns:9,rows:4,src:"walk/LEGS_pants_greenish.png"}),new TileSet({columns:9,rows:4,src:"walk/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:9,rows:4,src:"walk/HEAD_hair_blonde.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_male.png"}),new TileSet({columns:6,rows:1,src:"hurt/LEGS_pants_greenish.png"}),new TileSet({columns:6,rows:1,src:"hurt/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:6,rows:1,src:"hurt/HEAD_hair_blonde.png"})],slash:[new TileSet({columns:6,rows:4,src:"slash/BODY_human.png"}),new TileSet({columns:6,rows:4,src:"slash/LEGS_pants_greenish.png"}),new TileSet({columns:6,rows:4,src:"slash/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:6,rows:4,src:"slash/HEAD_hair_blonde.png"})],thrust:[new TileSet({columns:8,rows:4,src:"thrust/BODY_human.png"}),new TileSet({columns:8,rows:4,src:"thrust/LEGS_pants_greenish.png"}),new TileSet({columns:8,rows:4,src:"thrust/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:8,rows:4,src:"thrust/HEAD_hair_blonde.png"})],bow:[new TileSet({columns:13,rows:4,src:"bow/BODY_human.png"}),new TileSet({columns:13,rows:4,src:"bow/LEGS_pants_greenish.png"}),new TileSet({columns:13,rows:4,src:"bow/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:13,rows:4,src:"bow/HEAD_hair_blonde.png"})],spellcast:[new TileSet({columns:7,rows:4,src:"spellcast/BODY_human.png"}),new TileSet({columns:7,rows:4,src:"spellcast/LEGS_pants_greenish.png"}),new TileSet({columns:7,rows:4,src:"spellcast/TORSO_leather_armor_shirt_white.png"}),new TileSet({columns:7,rows:4,src:"spellcast/HEAD_hair_blonde.png"})]})};var s=[];$(function(){var e=1;for(var r=0;r<t*n;r++)s[r]=[],s[r].push(new Character({attackstyle:"slash",walk:[new TileSet({columns:9,rows:4,src:"walk/BODY_skeleton.png"})],slash:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:e,location:{row:CONSTANTS.TILE.MIDDLE.ROW()-2,column:CONSTANTS.TILE.MIDDLE.COLUMN(),x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}})),e+=1,s[r].push(new Character({attackstyle:"slash",walk:[new TileSet({columns:9,rows:4,src:"walk/BODY_skeleton.png"})],slash:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:e,location:{row:CONSTANTS.TILE.MIDDLE.ROW(),column:CONSTANTS.TILE.MIDDLE.COLUMN()-2,x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}})),e+=1,s[r].push(new Character({attackstyle:"slash",walk:[new TileSet({columns:9,rows:4,src:"walk/BODY_skeleton.png"})],slash:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:e,location:{row:CONSTANTS.TILE.MIDDLE.ROW()+2,column:CONSTANTS.TILE.MIDDLE.COLUMN(),x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}})),e+=1}),e.getRoomEnemies=function(){var e=s[room.location.column+room.location.row*n],t=(new Date).getTime();for(var r=0;r<e.length;r++)e[r].lastTime=t,e[r].elapsedTime=0;return e},e.moveCharacter=function(e){},e.attack=function(e){var t=s[room.location.column+room.location.row*n],r=character.location.row,i=character.location.column;e===CONSTANTS.DIRECTION.UP?r--:e===CONSTANTS.DIRECTION.LEFT?i--:e===CONSTANTS.DIRECTION.DOWN?r++:e===CONSTANTS.DIRECTION.RIGHT&&i++;for(var u=0;u<t.length;u++){var a=t[u].location;if(a.row===r&&a.column===i){var f=room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column;t[u].damage(1,function(){var e=o(i,r);character.statistics.experience.current+=this.statistics.experience.current,(l[f]=l[f]||[]).push(e),items.events.invoke("drop")},function(){t.splice(t.indexOf(this),1)})}}};var l=[];return e.getRoomItems=function(){return l[room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column]||[]},e.getSkills=function(){return[{name:"Power Thrust",description:"A powerful thrusting attack that causes significantly more damage than usual.",attack:"thrust",image:{icon:loadImage("skills/thrust/normal.png")},type:"active",area:2,duration:0,cooldown:1e3,cost:10,penetrates:!0,add:new Statistics({attack:10}),multiply:new Statistics({})}]},e}(),CONSTANTS={TILE:{WIDTH:48,HEIGHT:48,ROWS:7,COLUMNS:7,MIDDLE:{ROW:function(){return Math.floor(CONSTANTS.TILE.ROWS/2)},COLUMN:function(){return Math.floor(CONSTANTS.TILE.COLUMNS/2)}}},WIDTH:function(){return CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS},HEIGHT:function(){return CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS},WALL:{NONE:0,TOP:1,RIGHT:2,BOTTOM:4,LEFT:8,ALL:15},DIRECTION:{UP:0,LEFT:1,DOWN:2,RIGHT:3},INBETWEEN:function(){return canvas.width/2-(CONSTANTS.TILE.ROWS+2)*CONSTANTS.TILE.WIDTH/2-20},START:{X:function(){return canvas.width/2-CONSTANTS.WIDTH()/2},Y:function(){return canvas.height/2-CONSTANTS.HEIGHT()/2}},MAX_WEIGHT:4},tileset=new TileSet({columns:9,rows:16,src:"tiles.gif"}),skills=Server.getSkills(),canvas,context,background=loadImage("background.jpg"),character=Server.getCharacter(),contexts=[],room={location:Server.getCharacterRoomLocation(),events:new EventHandler},items={list:Server.getRoomItems(),events:new EventHandler},inventory_items=[],equipment_items={},enemies=[];$(function(){function n(){requestAnimFrame(n),t(),background&&background.complete&&context.drawImage(background,0,0,canvas.width,canvas.height),canvas.events.invoke("draw")}function r(){Sound.effect("sound/scream/scream"+(1+Math.floor(Math.random()*5))),setTimeout(r,5e3+5e3*Math.random())}canvas=$("#screen")[0],canvas.events=new EventHandler,context=canvas.getContext("2d"),context.font="12px Times New Roman",attachEvent(canvas,"click",function(e){var t=canvas.getBoundingClientRect();canvas.events.invoke("click",[{x:(e.pageX-t.left)*(canvas.width/canvas.clientWidth),y:(e.pageY-t.top)*(canvas.height/canvas.clientHeight)}])}),attachEvent(canvas,"mousemove",function(e){var t=canvas.getBoundingClientRect();canvas.events.invoke("mousemove",[{x:(e.pageX-t.left)*(canvas.width/canvas.clientWidth),y:(e.pageY-t.top)*(canvas.height/canvas.clientHeight)}])});var e=[];attachEvent(canvas,"keydown",function(t){e[t.which]||(canvas.events.invoke("keydown",t.which),e[t.which]=1),t.preventDefault()}),attachEvent(canvas,"keyup",function(t){canvas.events.invoke("keyup",t.which),e[t.which]=0,t.preventDefault()});var t=function(){window.setTimeout=function(e,r){var i=n++;return t[i]={f:e,t:r,r:r},i},window.setInterval=function(e,r){var i=n++;return t[i]={f:e,t:r,r:r,i:!0},i},window.setCatchup=function(e,r){var i=n++;return t[i]={f:e,t:r,r:r,i:!0,c:!0},i},window.clearTimeout=function(e){delete t[e]},window.clearInterval=function(e){delete t[e]};var e=(new Date).getTime(),t={},n=0;return function(){var n=(new Date).getTime(),r=n-e;e=n;for(var i in t)if(t.hasOwnProperty(i)&&(t[i].r-=r)<=0){var s=t[i].f;if(t[i].i)if(t[i].c)while(t[i]&&t[i].r<0)t[i].r+=t[i].t,s&&s();else t[i].r=t[i].t,s&&s();else s&&s(),delete t[i]}}}();n(),r()});$(function(){var e;room.events.attach("change",function(){e=Server.getTiles()}),canvas.events.attach("draw",function(){context.strokeStyle="black";for(var t=0;t<CONSTANTS.TILE.ROWS;t++)for(var n=0;n<CONSTANTS.TILE.COLUMNS;n++){if(tileset.complete){var r=e[n][t],i=r.column*tileset.width,s=r.row*tileset.height,o=CONSTANTS.START.X()+n*CONSTANTS.TILE.WIDTH,u=CONSTANTS.START.Y()+t*CONSTANTS.TILE.HEIGHT;context.drawImage(tileset.image,i,s,tileset.width,tileset.height,o,u,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}context.strokeRect(CONSTANTS.START.X()+n*CONSTANTS.TILE.WIDTH,CONSTANTS.START.Y()+t*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}})});var Blood=function(){function e(e){var t=e.count||500,n=e.colors||s,r=e.speed||50,o=e.size||5;for(var u=0;u<t;u++){var a=2*Math.PI*Math.random(),f=Math.random()*r;i.push({color:n[Math.floor(n.length*Math.random())],size:Math.ceil(o*Math.random()),location:{x:e.location.x,y:e.location.y},velocity:{x:Math.cos(a)*f,y:Math.sin(a)*f},room:{column:room.location.column,row:room.location.row}})}}var t=[],n,r,i=[];$(function(){canvas.events.attach("draw",function(){for(var e=i.length-1;e>=0;e--){var r=i[e],s=r.location,o=r.velocity;if(Math.abs(o.x)+Math.abs(o.y)<1||s.x<=CONSTANTS.START.X()||s.y<=CONSTANTS.START.Y()||s.x>=CONSTANTS.START.X()+n.width||s.y>=CONSTANTS.START.Y()+n.height){i.splice(e,1);var u=t[r.room.row][r.room.column].getContext("2d");u.fillStyle=r.color,u.fillRect(s.x-CONSTANTS.START.X(),s.y-CONSTANTS.START.Y(),r.size,r.size)}else r.room.column===room.location.column&&r.room.row===room.location.row&&(context.fillStyle=r.color,context.fillRect(s.x,s.y,r.size,r.size)),s.x+=o.x,s.y+=o.y,o.x/=2,o.y/=2}context.drawImage(n,CONSTANTS.START.X(),CONSTANTS.START.Y())}),room.events.attach("change",function(){var e=t[room.location.row]=t[room.location.row]||[],i=e[room.location.column];i||(i=document.createElement("canvas"),i.width=CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS,i.height=CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS),e[room.location.column]=n=i,r=i.getContext("2d")})});var s=["rgba(102, 000, 000, 0.30)","rgba(220, 020, 060, 0.30)","rgba(139, 000, 000, 0.30)","rgba(128, 000, 000, 0.30)","rgba(255, 255, 255, 0.30)","rgba(204, 017, 000, 0.30)"];return e}();$(function(){var e=0;items.events.attach("drop",function(){items.list=Server.getRoomItems();while(e<items.list.length){var t=items.list[e].sounds.move;Sound.effect(t[Math.floor(Math.random()*t.length)]),e++}}),room.events.attach("change",function(){items.list=Server.getRoomItems(),e=items.list.length}),canvas.events.attach("draw",function(){for(var e=items.list.length-1;e>=0;e--){var t=items.list[e],n=t.location,r=CONSTANTS.START,i=CONSTANTS.TILE;context.drawImage(items.list[e].portrait,r.X()+n.column*i.WIDTH,r.Y()+n.row*i.HEIGHT,i.WIDTH,i.HEIGHT)}})});$(function(){function n(){for(var e=enemies.length-1;e>=0;e--){var t=enemies[e];r(t)}}function r(e){if(enemies.indexOf(e)!=-1){var t,n=e.moves();n===0&&(t=function(){e.wait(function(){r(e)})});while(n>0&&character.statistics.health.current>0){n--;var i=[],s=new MazeGenerator(CONSTANTS.TILE.COLUMNS,CONSTANTS.TILE.ROWS),o;i.columns=CONSTANTS.TILE.COLUMNS,i.rows=CONSTANTS.TILE.ROWS;for(o=0;o<CONSTANTS.TILE.ROWS*CONSTANTS.TILE.COLUMNS;o++)i[o]=0;for(o=0;o<enemies.length;o++)if(e!==enemies[o]&&enemies[o].statistics.health.current>0){var u=enemies[o].location;i[u.column+u.row*CONSTANTS.TILE.COLUMNS]=CONSTANTS.WALL.ALL}if(e.statistics.health.current>0){var a=s.getPath(i,e.location.column,e.location.row,character.location.column,character.location.row);if(a.length>2){var f=a[a.length-2],l=(f.column-e.location.column)*CONSTANTS.TILE.WIDTH,c=(f.row-e.location.row)*CONSTANTS.TILE.HEIGHT;e.face(f.column,f.row),e.location.column=f.column,e.location.row=f.row,t=function(){e.moveBy(l,c,function(){e.face(character.location.column,character.location.row),r(e)})}}else Math.abs(character.location.column-e.location.column)+Math.abs(character.location.row-e.location.row)===1?(character.damage(1),e.face(character.location.column,character.location.row),t=function(){e.attack(function(){r(e)})}):t=function(){e.wait(function(){r(e)})}}}t&&t()}}var e=canvas.width/2-CONSTANTS.WIDTH()/2,t=canvas.height/2-CONSTANTS.HEIGHT()/2;canvas.events.attach("draw",function(){for(var e=0;e<enemies.length;e++)enemies[e].draw(context)}),room.events.attach("change",function(){enemies=Server.getRoomEnemies(),n()}),character.events.attach("trymove",function(e){for(var t=0;t<enemies.length;t++){var n=enemies[t];e.row===n.location.row&&e.column===n.location.column&&n.statistics.health.current>0&&(e.collides=!0)}})});$(function(){function n(){var n=canvas.width/2-CONSTANTS.WIDTH()/2-CONSTANTS.TILE.WIDTH,r=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,i=Math.floor((CONSTANTS.TILE.ROWS+2)/2);for(var s=0;s<CONSTANTS.TILE.ROWS+2;s++)(s!==i||e&CONSTANTS.WALL.LEFT)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n,r+s*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT),(s!==i||e&CONSTANTS.WALL.RIGHT)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+CONSTANTS.WIDTH()+CONSTANTS.TILE.WIDTH,r+s*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}function r(){var n=canvas.width/2-CONSTANTS.WIDTH()/2,r=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,i=Math.floor(CONSTANTS.TILE.COLUMNS/2);for(var s=0;s<CONSTANTS.TILE.COLUMNS;s++)(s!==i||e&CONSTANTS.WALL.TOP)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+s*CONSTANTS.TILE.WIDTH,r,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT),(s!==i||e&CONSTANTS.WALL.BOTTOM)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+s*CONSTANTS.TILE.WIDTH,r+CONSTANTS.TILE.HEIGHT+CONSTANTS.HEIGHT(),CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}var e,t={column:6,row:11};room.events.attach("change",function(){e=Server.getWalls()}),character.events.attach("trymove",function(t){var n=CONSTANTS.TILE.MIDDLE.ROW(),r=CONSTANTS.TILE.MIDDLE.COLUMN();t.collides=t.collides||t.column===-1&&t.row===n&&e&CONSTANTS.WALL.LEFT||t.column===-1&&t.row!==n,t.collides=t.collides||t.column===CONSTANTS.TILE.COLUMNS&&t.row===n&&e&CONSTANTS.WALL.RIGHT||t.column===CONSTANTS.TILE.COLUMNS&&t.row!==n,t.collides=t.collides||t.row===-1&&t.column===r&&e&CONSTANTS.WALL.TOP||t.row===-1&&t.column!==r,t.collides=t.collides||t.row===CONSTANTS.TILE.ROWS&&t.column===r&&e&CONSTANTS.WALL.BOTTOM||t.row===CONSTANTS.TILE.ROWS&&t.column!==r}),canvas.events.attach("draw",function(){n(),r()})});$(function(){var e=Server.getAllWalls(),t=0;setInterval(function(){t+=Math.PI/10,t%=2*Math.PI},100),canvas.events.attach("draw",function(){context.save(),context.translate(canvas.width-CONSTANTS.INBETWEEN()-10,10),context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, 0.5)",context.fillRect(0,0,CONSTANTS.INBETWEEN(),CONSTANTS.INBETWEEN());var n=CONSTANTS.INBETWEEN()/e.columns,r=CONSTANTS.INBETWEEN()/e.rows;for(var i=0;i<e.data.length;i++){var s=e.data[i],o=i%e.columns,u=Math.floor(i/e.rows);s!==undefined&&context.fillRect(n*o,r*u,n,r),s&CONSTANTS.WALL.TOP&&context.strokeRect(n*o,r*u,n,1),s&CONSTANTS.WALL.RIGHT&&context.strokeRect(n*o+n,r*u,1,r),s&CONSTANTS.WALL.BOTTOM&&context.strokeRect(n*o,r*u+r,n,1),s&CONSTANTS.WALL.LEFT&&context.strokeRect(n*o,r*u,1,r)}var a=n/4,f=r/4;context.fillStyle="rgba(255, 0, 0, "+((1+Math.sin(t))/4+.5)+")",context.fillRect(room.location.column*n+n/2-a/2,room.location.row*r+r/2-f/2,a-1,f-1),context.restore()}),room.events.attach("change",function(){e.data[room.location.column+room.location.row*e.columns]=Server.getWalls()}).invoke("change")});$(function(){canvas.events.attach("draw",function(){character.draw(context)}),canvas.events.attach("keydown",function(e){if(character.tween.isTweening()||character.statistics.health.current<=0)return;var t=1,n={column:character.location.column,row:character.location.row,collides:!1},r=0,i=0;e===37?(n.column--,character.display.row=CONSTANTS.DIRECTION.LEFT,r=-CONSTANTS.TILE.WIDTH):e===38?(n.row--,character.display.row=CONSTANTS.DIRECTION.UP,i=-CONSTANTS.TILE.HEIGHT):e===39?(n.column++,character.display.row=CONSTANTS.DIRECTION.RIGHT,r=CONSTANTS.TILE.WIDTH):e===40?(n.row++,character.display.row=CONSTANTS.DIRECTION.DOWN,i=CONSTANTS.TILE.HEIGHT):(t=0,e===32&&(Server.attack(character.display.row),character.attack()));if(t){character.events.invoke("trymove",n);if(!n.collides){var s=!0;n.column===-1?room.location.column--:n.column===CONSTANTS.TILE.COLUMNS?room.location.column++:n.row===-1?room.location.row--:n.row===CONSTANTS.TILE.ROWS?room.location.row++:s=!1,Server.moveCharacter(n),character.location.column=(n.column+CONSTANTS.TILE.COLUMNS)%CONSTANTS.TILE.COLUMNS,character.location.row=(n.row+CONSTANTS.TILE.ROWS)%CONSTANTS.TILE.ROWS,s?room.events.invoke("change"):character.moveBy(r,i)}}})});$(function(){function i(e,t,i,s,o,u){u=Math.min(Math.max(0,u),1),context.fillStyle=e;var a=s/r.width,f=o/r.height;context.drawImage(r,t,i,s,o),context.fillRect(t+12*a,i+8*f,(s-24*a)*u,15*f),context.drawImage(n,t,i,s,o)}var e=canvas.width/2-CONSTANTS.WIDTH()/2,t=canvas.height/2-CONSTANTS.HEIGHT()/2,n=loadImage("health/foreground_gray.png"),r=loadImage("health/background.png");canvas.events.attach("draw",function(){var n=character.statistics.health.current/character.statistics.health.max,r=character.statistics.experience.current/character.statistics.experience.max;i("red",10,t-CONSTANTS.TILE.HEIGHT,CONSTANTS.INBETWEEN(),25,n),i("blue",10,t-CONSTANTS.TILE.HEIGHT+35,CONSTANTS.INBETWEEN(),25,1),i("green",10,t-CONSTANTS.TILE.HEIGHT+70,CONSTANTS.INBETWEEN(),25,r);for(var s=0;s<enemies.length;s++){var o=enemies[s].location,u=enemies[s].statistics.health;u.current>0&&i("red",e+5+o.column*CONSTANTS.TILE.WIDTH+o.x,t+o.row*CONSTANTS.TILE.HEIGHT+o.y,CONSTANTS.TILE.WIDTH-10,10,u.current/u.max)}})});$(function(){canvas.events.attach("keydown",function(e){if(e===17){var t=inventory_items.indexOf(undefined);for(var n=0;n<items.list.length;n++){var r=items.list[n];if(r.location.column===character.location.column&&r.location.row===character.location.row){if(t!==-1){inventory_items[t]=r,Sound.effect(r.sounds.move),items.list.splice(n,1);break}alert("You have no room in your inventory for that item.")}}}e===73?inventory_items.visible=!inventory_items.visible:inventory_items.visible=0});var e={x:0,y:100},t=5,n=CONSTANTS.TILE.WIDTH,r=CONSTANTS.TILE.HEIGHT,i=4,s=6,o,u=24,a=(n+t*2)*s,f=t*2+u+(r+t*2)*i;inventory_items.visible=0,loadImage("window/texture.png",function(e){o=context.createPattern(e,"repeat")});var l={"Equip / Use":function(e){var t=inventory_items.indexOf(e),n=inventory_items.indexOf(undefined),r,i=e.type;if(e.type==="mainhand"){if(e.weight===1)equipment_items.mainhand.item&&equipment_items.mainhand.item.weight===4?unequip("mainhand",t):unequip("offhand",t),i="offhand";else if(e.weight===2)unequip("mainhand",t);else if(e.weight===3)unequip("mainhand",t);else if(e.weight===4){if(!!equipment_items.offhand.item&&n===-1){alert("You have no room in your inventory for your equipped items.");return}unequip("mainhand",t),equipment_items.offhand.item&&unequip("offhand",n)}}else unequip(e.type,t);equip(e,i)},Drop:function(e){inventory_items[inventory_items.indexOf(e)]=undefined,e.location.row=character.location.row,e.location.column=character.location.column,items.list.push(e),Sound.effect(e.sounds.move)},Destroy:function(e){inventory_items[inventory_items.indexOf(e)]=undefined,Sound.effect(e.sounds.move)}};for(var c=0;c<i;c++)for(var h=0;h<s;h++){var p=t+(t*2+n)*h,d=t*3+u+(t*2+r)*c;inventory_items.push(undefined),contexts.push({column:h,row:c,x:p,y:d,width:n,height:r,contains:function(t){if(inventory_items.visible){var n=this.x+e.x,r=this.y+e.y,i=n+this.width,o=r+this.height;if(t.x>=n&&t.y>=r&&t.x<=i&&t.y<=o){var u=inventory_items[this.column+this.row*s];if(u)return{context:u,menu:l}}}}})}canvas.events.attach("draw",function(){if(inventory_items.visible){e.x=canvas.width/2-a/2,e.y=canvas.height/2-f/2,context.save(),context.globalAlpha=.8,context.translate(e.x,e.y),context.strokeStyle="black",context.fillStyle=o,context.fillRect(0,0,a,f),context.strokeRect(0,0,a,f),context.strokeRect(t,t,a-t*2,u);for(var l=0;l<i;l++)for(var c=0;c<s;c++){var h=t+(t*2+n)*c,p=t*3+u+(t*2+r)*l,d=inventory_items[c+l*s];context.strokeRect(h,p,n,r),d&&context.drawImage(d.portrait,h,p,n,r)}context.strokeStyle="white",context.textBaseline="middle",context.textAlign="left",context.strokeText("Inventory",t*2,t+u/2,a-t*2),context.restore()}})});$(function(){var e=296,t=325,n,r=5,i=22,s={x:400,y:0};equipment_items.visible=0,loadImage("window/texture.png",function(e){n=context.createPattern(e,"repeat")}),equipment_items.head={rectangle:{x:e/2-32,y:r*3+i,width:64,height:64},empty:loadImage("items/head.png")},equipment_items.neck={rectangle:{x:e/2-64-r*2,y:r*3+i+equipment_items.head.rectangle.height-32,width:32,height:32},empty:loadImage("items/neck.png")},equipment_items.chest={rectangle:{x:e/2-48,y:r*5+i+equipment_items.head.rectangle.height,width:96,height:86},empty:loadImage("items/chest.png")},equipment_items.mainhand={rectangle:{x:r,y:r*5+i+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/mainhand.png")},equipment_items.offhand={rectangle:{x:e-r-80,y:r*5+i+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/offhand.png")},equipment_items.legs={rectangle:{x:e/2-56,y:r*7+i+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:112,height:112},empty:loadImage("items/legs.png")},equipment_items.feet={rectangle:{x:r,y:r*7+i+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/feet.png")},equipment_items.hands={rectangle:{x:e-72-r,y:r*7+i+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/hands.png")},equipment_items.rightring={rectangle:{x:e/2+r*3+equipment_items.legs.rectangle.width/2,y:r*9+i+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")},equipment_items.leftring={rectangle:{x:e/2-r*3-equipment_items.legs.rectangle.width/2-30,y:r*9+i+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")};var o={Unequip:function(e){var t=e.item.type;e===equipment_items.offhand&&(t="offhand"),unequip(t,inventory_items.indexOf(undefined))}};for(var u in equipment_items)contexts.push({item:equipment_items[u],contains:function(e){var t=this.item;if(equipment_items.visible&&t.item){var n=s.x+t.rectangle.x,r=s.y+t.rectangle.y,i=r+t.rectangle.height,u=n+t.rectangle.width;if(e.x>=n&&e.y>=r&&e.x<=u&&e.y<=i)return{context:t,menu:o}}}});canvas.events.attach("keydown",function(e){e===69?equipment_items.visible=!equipment_items.visible:equipment_items.visible=0}),canvas.events.attach("draw",function(){if(equipment_items.visible){s.x=canvas.width/2-e/2,s.y=canvas.height/2-t/2,context.save(),context.globalAlpha=.8,context.translate(s.x,s.y),context.strokeStyle="black",context.fillStyle=n,context.fillRect(0,0,e,t),context.strokeRect(r,r,e-r*2,i),context.strokeRect(0,0,e,t);for(var o in equipment_items){var u=equipment_items[o],a=u.rectangle,f=u.empty,l=u.item;a&&(l?context.drawImage(l.portrait,a.x,a.y,a.width,a.height):f.complete&&context.drawImage(f,a.x,a.y,a.width,a.height),context.strokeRect(a.x,a.y,a.width,a.height))}context.strokeStyle="white",context.textAlign="left",context.textBaseline="middle",context.strokeText("Equipment",r+5,r+i/2,e),context.restore()}})});$(function(){function l(t){if(t){var n,r=e;if(equipment_items.visible)t=t.item;else{var s=t.type;s==="mainhand"&&t.weight===1&&(!equipment_items.mainhand.item||equipment_items.mainhand.item.weight!==4)&&(s="offhand"),n=equipment_items[s].item,n&&(r*=2)}context.save(),context.translate(clamp(a.x,0,canvas.width-r),clamp(a.y,0,canvas.height-u)),context.strokeStyle="black",context.fillStyle=i,context.fillRect(0,0,r,u),context.strokeRect(0,0,r,u),p(t),n&&(context.translate(e,0),p(n)),context.restore()}}function c(){for(var e=0;e<contexts.length;e++){var t=contexts[e].contains(a);if(t)return t.context}return!1}function h(){r.x=canvas.width/2-e/2,r.y=canvas.height/2-u/2,context.save(),context.translate(r.x,r.y),context.strokeStyle="black",context.fillStyle=i,context.fillRect(0,0,e,u),context.strokeRect(0,0,e,u),p(character),context.restore()}function p(r){context.strokeRect(n,n,e-n*2,t);var i=e/2,o=i;context.strokeRect(n,n*3+t,i-n*2,o-n*2),context.strokeRect(e-i+n,n*3+t,i-n*2,o-n*2),r.portrait.complete&&context.drawImage(r.portrait,e-i+n,n*3+t,i-n*2,i-n*2),context.fillStyle="white",context.textAlign="right",context.textBaseline="bottom",context.fillText(r.name,i-n*2,t+o,i),context.textBaseline="middle",i=e/3;for(var u=0;u<s.length;u++)context.textAlign="right",context.fillText(s[u][0].toUpperCase()+s[u].substring(1),i-n*2,t+n*3+o+u*(n*2+t)+t/2,e),context.strokeRect(n,t+n*3+o+u*(n*2+t),i-n*2,t),context.textAlign="center",context.fillText(r.statistics[s[u]].max,i+i/2,t+n*3+o+u*(n*2+t)+t/2,i-n*2),context.strokeRect(n+i,t+n*3+o+u*(n*2+t),i-n*2,t),context.fillText(r.statistics[s[u]].current,2*i+i/2,t+n*3+o+u*(n*2+t)+t/2,i-n*2),context.strokeRect(n+2*i,t+n*3+o+u*(n*2+t),i-n*2,t);context.textAlign="left",context.fillText("Statistics",n*2,n+t/2,e)}var e=300,t=22,n=5,r={x:0,y:0},i,s=Statistics.getStatisticNames(),o=0,u=t+n*2+e/2+s.length*(n*2+t),a={x:0,y:0},f=0;loadImage("window/texture.png",function(e){i=context.createPattern(e,"repeat")}),canvas.events.attach("mousemove",function(e){a=e,f=1}),canvas.events.attach("keydown",function(e){e===83?o=!o:o=0,f=0}),canvas.events.attach("draw",function(){context.save(),context.globalAlpha=.8;if(o)h();else if(!contexts.contextmenu&&f){l(c());if(!equipment_items.visible&&!inventory_items.visible&&!skills.visible){var e=Math.floor((a.x-CONSTANTS.START.X())/CONSTANTS.TILE.WIDTH),t=Math.floor((a.y-CONSTANTS.START.Y())/CONSTANTS.TILE.HEIGHT);for(var n=0;n<items.list.length;n++){var r=items.list[n],i=r.location;if(i.column===e&&i.row===t){l(r);break}}}}context.restore()})});$(function(){var e,t=5,n,r=t*2+12,i,s,o;canvas.events.attach("click",function(t){if(e){var r=Object.keys(e.menu);e.menu[r[o]](e.context),contexts.contextmenu=e=0}else{o=0,e=0,n=t;for(var i=0;i<contexts.length&&!e;i++)e=contexts[i].contains(t);contexts.contextmenu=e,n.x-=5,n.y-=5}}),canvas.events.attach("keydown",function(){contexts.contextmenu=e=0}),canvas.events.attach("mousemove",function(t){e&&(t.x<n.x||t.y<n.y||t.x>=n.x+s||t.y>=n.y+i)?contexts.contextmenu=e=0:e&&(o=Math.floor((t.y-n.y)/r))}),canvas.events.attach("draw",function(){if(e){var u=Object.keys(e.menu),a=0,f;for(f=0;f<u.length;f++)s=context.measureText(u[f]).width,s>a&&(a=s);i=r*u.length,context.fillStyle="gray",context.strokeStyle="black",context.textBaseline="middle",context.textAlign="left",a+=t*2,s=a,context.fillRect(n.x,n.y,a,i),context.fillStyle="lightgray",context.fillRect(n.x,n.y+r*o,s,r);for(f=0;f<u.length;f++)context.strokeText(u[f],n.x+t,n.y+(f+1)*r-r/2,a)}})});$(function(){var e=[];alert=function(t){e.unshift(t),setTimeout(function(){e.pop()},5e3)},canvas.events.attach("draw",function(){context.fillStyle="white",context.textAlign="right",context.textBaseline="bottom";for(var t=Math.min(5,e.length)-1;t>=0;t--)context.fillText(e[t],canvas.width-5,canvas.height-12*t-5,CONSTANTS.INBETWEEN())})});$(function(){skills.visible=0;var e,t={x:0,y:0},n,r;loadImage("window/texture.png",function(t){e=context.createPattern(t,"repeat")}),canvas.events.attach("keydown",function(e){var t=parseInt(String.fromCharCode(e));skills.visible&&r&&!isNaN(t)?i[t]=r:e===82?skills.visible=!skills.visible:skills.visible=0});var i=[];canvas.events.attach("mousemove",function(e){t=e}),canvas.events.attach("click",function(e){n=e});var s=5,o=CONSTANTS.TILE.WIDTH,u=CONSTANTS.TILE.HEIGHT,a=4,f=6,e,l=24,c=(o+s*2)*f,h=s*2+l+(u+s*2)*a;inventory_items.visible=0,start={x:canvas.width/2-c/2,y:canvas.height/2-h/2},canvas.events.attach("draw",function(){if(skills.visible){context.save(),context.translate(start.x,start.y),context.globalAlpha=.8,context.strokeStyle="black",context.fillStyle=e,context.fillRect(0,0,c,h),context.strokeRect(0,0,c,h),context.strokeRect(s,s,c-s*2,l);var p=0;for(var d=0;d<a;d++)for(var v=0;v<f;v++,p++){var m=s+v*(o+s*2),g=3*s+l+d*(u+s*2);context.strokeRect(m,g,o,u);if(p<skills.length){var y=skills[p];context.drawImage(y.image.icon,m,g,o,u);if(t.x>=start.x+m&&t.y>=start.y+g&&t.x<=start.x+m+o&&t.y<=start.y+g+u){var b=generateText({text:skills[p].description,color:"white",width:100});context.fillRect(t.x-start.x,t.y-start.y,100,b.height+s*4),context.strokeRect(t.x-start.x,t.y-start.y,100,b.height+s*4),context.drawImage(b,t.x-start.x,t.y-start.y)}n&&n.x>=start.x+m&&n.y>=start.y+g&&n.x<=start.x+m+o&&n.y<=start.y+g+u&&(r=y)}}context.strokeStyle="white",context.textBaseline="middle",context.textAlign="left",context.strokeText("Skills",s*2,s+l/2,c-s*2),context.globalAlpha=1,context.restore()}for(var d=0;d<10;d++){var m=d*o+s+d*s,g=canvas.height-u-s;context.strokeRect(m,g,o,u),context.fillRect(m,g,o,u),i[d]&&context.drawImage(i[d].image.icon,m,g,o,u)}n=0})});