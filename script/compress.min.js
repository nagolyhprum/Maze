
var Tween=(function(){function Tween(){this.queue=[];this.locked=0;}
Tween.prototype.push=function(tween){this.queue.push(tween);return this.process();};Tween.prototype.clear=function(){for(var i=0;i<this.queue.length;i++){this.queue[i].isCleared=true;}
return this;};Tween.prototype.process=function(){var me=this;if(!me.locked&&me.queue.length){me.locked=1;var current=me.queue[0],interval=myInterval(function(){if(current.isCleared||current.change()===false){if(interval){clearInterval(interval);}
me.queue.shift();if(current.complete){current.complete();}
me.locked=0;me.process();}},current.isCleared?0:current.interval);current.init&&current.init();}
return me;};function myInterval(f,t){return setCatchup(f,t);}
Tween.prototype.isTweening=function(){return this.locked;};return Tween;}());
var MazeGenerator=(function(){function table(columns,rows,value){var t=[],size=rows*columns;for(var i=0;i<size;i++){t[(i%columns)+Math.floor(i/columns)*rows]=value;}
return t;}
function MazeGenerator(columns,rows){this.columns=columns;this.rows=rows;}
MazeGenerator.prototype.hasVisited=function(visited,column,row){return visited[column+row*visited.columns];};MazeGenerator.prototype.visit=function(visited,column,row){visited[column+row*visited.columns]=1;return this;};MazeGenerator.prototype.generateMaze=function(){var visited=[];visited.columns=this.columns;var walls=table(this.columns,this.rows,MazeGenerator.walls.all);walls.columns=this.columns;walls.rows=this.rows;var toVisit=[this.generateCell(Math.floor(Math.random()*this.columns),Math.floor(Math.random()*this.rows))];this.visit(visited,toVisit[0].column,toVisit[0].row);while(toVisit.length){var tv=toVisit[toVisit.length-1],direction=tv.directions.splice(Math.floor(Math.random()*tv.directions.length),1)[0];if(direction){if(!this.hasVisited(visited,direction.column,direction.row)){toVisit.push(this.generateCell(direction.column,direction.row));this.visit(visited,direction.column,direction.row);walls[tv.column+tv.row*this.columns]^=direction.remove.current;walls[direction.column+direction.row*this.columns]^=direction.remove.other;}}else{toVisit.pop();}}
return walls;};MazeGenerator.prototype.generateCell=function(column,row,walls){walls=walls||[];var directions=[],columns=walls.columns||this.columns,rows=walls.rows||this.rows;if(row>0&&!(walls&&(walls[column+row*columns]&MazeGenerator.walls.top))){directions.push({column:column,row:row-1,remove:{current:MazeGenerator.walls.top,other:MazeGenerator.walls.bottom}});}
if(column+1<columns&&!(walls&&(walls[column+row*columns]&MazeGenerator.walls.right))){directions.push({column:column+1,row:row,remove:{current:MazeGenerator.walls.right,other:MazeGenerator.walls.left}});}
if(row+1<rows&&!(walls&&(walls[column+row*columns]&MazeGenerator.walls.bottom))){directions.push({column:column,row:row+1,remove:{current:MazeGenerator.walls.bottom,other:MazeGenerator.walls.top}});}
if(column>0&&!(walls&&(walls[column+row*columns]&MazeGenerator.walls.left))){directions.push({column:column-1,row:row,remove:{current:MazeGenerator.walls.left,other:MazeGenerator.walls.right}});}
return{column:column,row:row,directions:directions,weight:1,compareTo:function(other){return this.weight-other.weight;}};};MazeGenerator.prototype.generateDomElement=function(walls,cellsize,id){var dom="<div id='"+id+"' class='maze' style='border:1px solid black;float:left;width:"+(walls.columns*cellsize+walls.columns*2)+"px;height:"+(walls.rows*cellsize+walls.rows*2)+"px;'>";for(var i=0;i<walls.length;i++){if(i%walls.columns===0){dom+="<div style='clear:both;'></div>";}
var style="";for(var j in MazeGenerator.walls){if(j!=="all"){if(walls[i]&MazeGenerator.walls[j]){style+="border-"+j+":1px solid black;";}else{style+="padding-"+j+":1px;";}}}
dom+="<div class='cell' style='width:"+cellsize+"px;height:"+cellsize+"px;float:left;"+style+"'></div>";}
return dom+"</div>";};MazeGenerator.walls={top:1,right:2,bottom:4,left:8,all:15};MazeGenerator.prototype.getPath=function(walls,fromColumn,fromRow,toColumn,toRow){var visited=[];visited.columns=walls.columns;var toVisit=new PriorityQueue();var cell=this.generateCell(fromColumn,fromRow,walls),path=[];cell.parent=null;cell.length=0;cell.weight=this.heuristics(fromColumn,fromRow,toColumn,toRow);toVisit.queue(cell);while(toVisit.length&&!path.length){var current=toVisit.dequeue();this.visit(visited,current.column,current.row);if(current.column===toColumn&&current.row===toRow){while(current){path.push(current);current=current.parent;}}else{for(var i=0;i<current.directions.length;i++){var d=current.directions[i];if(!this.hasVisited(visited,d.column,d.row)){cell=this.generateCell(d.column,d.row,walls);cell.length=current.length+1;cell.weight=cell.length+this.heuristics(cell.column,cell.row,toColumn,toRow);cell.parent=current;toVisit.queue(cell);}}}}
return path;};MazeGenerator.prototype.heuristics=function(fromColumn,fromRow,toColumn,toRow){return Math.abs(fromColumn-toColumn)+Math.abs(fromRow-toRow);};function PriorityQueue(){}
PriorityQueue.prototype=new Array();PriorityQueue.prototype.queue=function(e){var index=this.push(e)-1,parent=Math.floor((index+1)/2)-1;while(parent>=0&&this[parent].compareTo(this[index])>0){this.swap(parent,index);index=parent;parent=Math.floor((index+1)/2)-1;}
return this;};PriorityQueue.prototype.swap=function(i,j){var temp=this[i];this[i]=this[j];this[j]=temp;};PriorityQueue.prototype.dequeue=function(){var r=this.shift(),from=0,to,main=this.pop();if(main){this.unshift(main);var left=this[from*2+1],right=this[from*2+2];while((left!==undefined&&main.compareTo(left)>0)||(right!==undefined&&main.compareTo(right)>0)){if((left!==undefined&&main.compareTo(left)>0)&&(right!==undefined&&main.compareTo(right)>0)){if(left.compareTo(right)<0){to=from*2+1;}else{to=from*2+2;}}else if(left!==undefined&&main.compareTo(left)>0){to=from*2+1;}else if(right!==undefined&&main.compareTo(right)>0){to=from*2+2;}
this.swap(to,from);from=to;left=this[from*2+1];right=this[from*2+2];}}
return r;};return MazeGenerator;}());
var EventHandler=(function(){function EventHandler(evt){this.events={};if(evt&&evt.events){for(var i in evt.events){this.events[i]=evt.events[i].slice(0);}}}
EventHandler.prototype.invoke=function(n,args){args=args instanceof Array?args:[args];var r=this.events[n];if(!r){return this;}
for(var i=0;i<r.length;i++){r[i].apply(undefined,args);}
return this;};EventHandler.prototype.attach=function(n,e){(this.events[n]=(this.events[n]||[])).push(e);return this;};EventHandler.prototype.detach=function(n,e){var r=this.events[n];if(!r){return this;}
for(var i=0;i<r.length;i++){if(r[i]===e){r.splice(i,1);break;}}
return this;};return EventHandler;}());
String.prototype.endsWith=function(suffix){return this.indexOf(suffix,this.length-suffix.length)!==-1;};function attachEvent(ele,name,evt){if(ele.addEventListener){ele.addEventListener(name,evt,false);}else if(ele.attachEvent){ele.attachEvent("on"+name,evt);}else{ele["on"+name]=evt;}}
function detachEvent(element,eventName,handler){if(element.addEventListener){element.removeEventListener(eventName,handler,false);}else if(element.detachEvent){element.detachEvent('on'+eventName,handler);}else{element['on'+eventName]=null;}}
function clamp(input,min,max){return Math.min(Math.max(input,min),max);}
var Sound=(function(){var a=new Audio(),supported=[],cache={},S={};if(a.canPlayType){if(a.canPlayType('audio/mpeg;').replace("no","")){supported.push(".mp3");}
if(a.canPlayType('audio/wav;').replace("no","")){supported.push(".wav");}
if(a.canPlayType('audio/ogg;').replace("no","")){supported.push(".ogg");}}
S.effect=function(src,complete){var c=cache[src];if(!c){c=cache[src]=[];}
var a,index=0;for(var i=0;i<c.length&&!a;i++){if(c[i].paused&&c[i].canplay){a=c[i];}}
if(!a){a=new Audio();a.autoplay=true;c.push(a);attachEvent(a,"canplaythrough",function(){this.canplay=true;});a.src=S.root+src+supported[index];index=index+1;attachEvent(a,"error",function(){if(index<supported.length){a.src=S.root+src+supported[index];index=index+1;}});}else{a.play();}
var f=function(){complete&&complete();detachEvent(this,"ended",f);};attachEvent(a,"ended",f);return function(){a.autoplay=false;a.pause();};};S.music=function(src){var stopper,f=function(){stopper=Sound.effect(src,f);};f();return function(){stopper();};};S.root="./";return S;}());Sound.root="audio/";Sound.music("music/dungeon");var loadImage=(function(){var images={},events={};return function(src,complete){src=loadImage.root+src;var image=images[src],event=events[src];if(!image){image=images[src]=new Image();image.src=src;}
if(complete){if(image.complete){complete(image);}else if(event){event.attach("load",complete);}else{event=events[src]=new EventHandler();event.attach("load",complete);attachEvent(image,"load",function(){events[src].invoke("load",[image]);});}}
return image;};}());loadImage.root="images/";var TileSet=function(args){var me=this;args=args||{};me.rows=args.rows||1;me.columns=args.columns||1;args.location=args.location||{};me.location={row:args.location.row||0,column:args.location.column||0,x:args.location.x||0,y:args.location.y||0};args.display=args.display||{};me.display={row:args.display.row||0,column:args.display.column||0};me.src=args.src;this.image=loadImage(args.src,function(image){me.width=image.width/me.columns;me.height=image.height/me.rows;me.complete=1;});};TileSet.prototype.draw=function(context,x,y,w,h){context.drawImage(this.image,this.display.column*this.width,this.display.row*this.height,this.width,this.height,x,y,w,h);};var $=(function(){var onload=new EventHandler();function hasLoaded(){return document.body&&document.body.readyState==="complete";}
function $(f){var to=typeof f;if(to==="function"){if(hasLoaded()){f();return true;}else{onload.attach("load",f);return false;}}else if(to==="string"){return document.querySelectorAll(f);}else{return false;}}
if(hasLoaded()){onload.invoke("load");}else{attachEvent(window,"load",function(){onload.invoke("load");});}
return $;}());var requestAnimFrame=(function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60);};}());var getSign=(function(){return function(x){return x?x/Math.abs(x):0;};}());function Statistics(args){args=args||{};var stats=["health","energy","experience","strength","defense","speed"];for(var i=0;i<stats.length;i++){var stat=stats[i];args[stat]=args[stat]||{};this[stat]={max:args[stat].max||0,current:args[stat].current||0};}}
function Character(args){this.tween=new Tween();args=args||{};this.events=new EventHandler();this.walk=args.walk||[];this.attack=args.attack||[];this.hurt=args.hurt||[];this.active=this.walk;this.id=args.id;this.name=args.name;this.portrait=loadImage(args.portrait);args.location=args.location||{};this.location={column:args.location.column||0,row:args.location.row||0,x:args.location.x||0,y:args.location.y||0};args.display=args.display||{};this.display={row:args.display.row||0,column:args.display.column||0};this.statistics=new Statistics(args.statistics);args.sounds=args.sounds||{};this.sounds={slash:args.sounds.slash||[],hurt:args.sounds.hurt||[]};}
Character.prototype.draw=function(ctx){for(var i=0;i<this.active.length;i++){var tile=this.active[i];if(tile.complete){ctx.drawImage(tile.image,this.display.column*tile.width,this.display.row*tile.height,tile.width,tile.height,CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+this.location.x,CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.HEIGHT+this.location.y,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}}};var SPEED=100,SLEEP=500;Character.prototype.timeToMove=function(){return Math.ceil(SPEED/this.statistics.speed.current*CONSTANTS.TILE.WIDTH)+SLEEP;};Character.prototype.moves=function(){var time=new Date().getTime(),timeToMove=this.timeToMove(),moves;this.elapsedTime+=time-this.lastTime;this.lastTime=time;moves=Math.floor(this.elapsedTime/timeToMove);this.elapsedTime=this.elapsedTime%timeToMove;return moves;};var WALK=["sound/walk/stepstone_1","sound/walk/stepstone_2","sound/walk/stepstone_3","sound/walk/stepstone_4","sound/walk/stepstone_5","sound/walk/stepstone_6","sound/walk/stepstone_7","sound/walk/stepstone_8"];Character.prototype.moveBy=function(horizontal,vertical,complete){var me=this;Sound.effect(WALK[Math.floor(WALK.length*Math.random())]);this.tween.push({init:function(){me.location.x=-horizontal;me.location.y=-vertical;},change:function(){me.location.x+=getSign(horizontal);me.location.y+=getSign(vertical);me.display.column=Math.max((me.display.column+1)%me.active[0].columns,1);return Math.abs(me.location.x)+Math.abs(me.location.y)!==0;},interval:SPEED/this.statistics.speed.current,complete:function(){me.display.column=me.location.x=me.location.y=0;setTimeout(complete,SLEEP);}});};Character.prototype.slash=function(complete){var me=this,column=-1;Sound.effect(this.sounds.slash[Math.floor(this.sounds.slash.length*Math.random())]);this.tween.push({init:function(){me.display.column=0;me.active=me.attack;},change:function(){column++;me.display.column=Math.floor(column/CONSTANTS.TILE.WIDTH*me.active[0].columns);return column!==CONSTANTS.TILE.WIDTH;},interval:SPEED/this.statistics.speed.current,complete:function(){me.active=me.walk;me.display.column=0;setTimeout(complete,SLEEP);}});};Character.prototype.face=function(column,row){if(Math.abs(this.location.column-column)>Math.abs(this.location.row-row)){if(this.location.column>column){this.display.row=CONSTANTS.DIRECTION.LEFT;}else if(this.location.column<column){this.display.row=CONSTANTS.DIRECTION.RIGHT;}}else{if(this.location.row>row){this.display.row=CONSTANTS.DIRECTION.UP;}else if(this.location.row<row){this.display.row=CONSTANTS.DIRECTION.DOWN;}}};var BLOOD=["sound/blood/blood1","sound/blood/blood2","sound/blood/blood3","sound/blood/blood4"];Character.prototype.damage=function(damage,killed,complete){var health=this.statistics.health;if(health.current>0){Sound.effect(BLOOD[Math.floor(BLOOD.length*Math.random())]);new Blood({location:{x:CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.WIDTH/2,y:CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.HEIGHT/2}});Sound.effect(this.sounds.hurt[Math.floor(this.sounds.hurt.length*Math.random())]);health.current-=damage;if(health.current<=0){var me=this;killed&&killed.call(this);this.die(complete);}}};Character.prototype.die=function(complete){var me=this;this.tween.push({init:function(){me.active=me.hurt;me.display={row:0,column:0};},change:function(){me.display.column=me.display.column+1;return me.display.column!==me.active[0].columns;},interval:100,complete:function(){complete&&complete.call(me);}});};Character.prototype.wait=function(complete){this.tween.push({change:function(){return false;},interval:10,complete:complete});};function Item(args){args=args||{};args.location=args.location||{};this.location={row:args.location.row||0,column:args.location.column||0,x:args.location.x||0,y:args.location.y||0};this.type=args.type;this.portrait=loadImage(args.portrait);this.statistics=new Statistics(args.statistics);this.id=args.id;this.name=args.name;args.sounds=args.sounds||{};this.sounds={move:args.sounds.move||[]};}
var Server=(function(){var Server={};Server.getTiles=function(){var r=[],s;for(var i=0;i<CONSTANTS.TILE.ROWS;i++){r.push(s=[]);for(var j=0;j<CONSTANTS.TILE.COLUMNS;j++){s.push({row:11,column:0});}}
return r;};var rows=5,columns=5,mg=new MazeGenerator(columns,rows),walls=mg.generateMaze();Server.getWalls=function(){return walls[room.location.row*columns+room.location.column];};Server.getAllWalls=function(){var data=[];for(var i=0;i<walls.length;i++){data[i]=undefined;}
return{data:data,rows:rows,columns:columns};};Server.getCharacterRoomLocation=function(){return{row:0,column:0};};Server.getCharacter=function(){return new Character({portrait:"face/FlareMaleHero1.png",name:"Logan",sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/grunts/grunt1","sound/grunts/grunt2","sound/grunts/grunt3","sound/grunts/grunt4","sound/grunts/grunt5","sound/grunts/grunt6","sound/grunts/grunt7","sound/grunts/grunt8","sound/grunts/grunt9","sound/grunts/grunt10","sound/grunts/grunt11"],walk:[]},statistics:{health:{max:50,current:50},speed:{current:25,max:25},experience:{current:0,max:100}},display:{row:2},walk:[new TileSet({columns:9,rows:4,src:"walkcycle/BODY_male.png"}),new TileSet({columns:9,rows:4,src:"walkcycle/LEGS_pants_greenish.png"}),new TileSet({columns:9,rows:4,src:"walkcycle/TORSO_robe_shirt_brown.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_male.png"}),new TileSet({columns:6,rows:1,src:"hurt/LEGS_pants_greenish.png"}),new TileSet({columns:6,rows:1,src:"hurt/TORSO_robe_shirt_brown.png"})],attack:[new TileSet({columns:6,rows:4,src:"slash/BODY_human.png"}),new TileSet({columns:6,rows:4,src:"slash/LEGS_pants_greenish.png"}),new TileSet({columns:6,rows:4,src:"slash/TORSO_robe_shirt_brown.png"}),new TileSet({columns:6,rows:4,src:"slash/WEAPON_dagger.png"})]});};var enemies=[];$(function(){var id=1;for(var i=0;i<rows*columns;i++){if(1){enemies[i]=[];enemies[i].push(new Character({walk:[new TileSet({columns:9,rows:4,src:"walkcycle/BODY_skeleton.png"})],attack:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:id,location:{row:CONSTANTS.TILE.MIDDLE.ROW()-2,column:CONSTANTS.TILE.MIDDLE.COLUMN(),x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}}));id=id+1;enemies[i].push(new Character({walk:[new TileSet({columns:9,rows:4,src:"walkcycle/BODY_skeleton.png"})],attack:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:id,location:{row:CONSTANTS.TILE.MIDDLE.ROW(),column:CONSTANTS.TILE.MIDDLE.COLUMN()-2,x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}}));id=id+1;enemies[i].push(new Character({walk:[new TileSet({columns:9,rows:4,src:"walkcycle/BODY_skeleton.png"})],attack:[new TileSet({columns:6,rows:4,src:"slash/BODY_skeleton.png"})],hurt:[new TileSet({columns:6,rows:1,src:"hurt/BODY_skeleton.png"})],id:id,location:{row:CONSTANTS.TILE.MIDDLE.ROW()+2,column:CONSTANTS.TILE.MIDDLE.COLUMN(),x:0,y:0},display:{row:0,column:0},statistics:{health:{max:3,current:3},speed:{current:10,max:10},experience:{current:5,max:5}},sounds:{slash:["sound/battle/swing1","sound/battle/swing2","sound/battle/swing3"],hurt:["sound/NPC/shade/shade1","sound/NPC/shade/shade2","sound/NPC/shade/shade3","sound/NPC/shade/shade4","sound/NPC/shade/shade5","sound/NPC/shade/shade6","sound/NPC/shade/shade7","sound/NPC/shade/shade8","sound/NPC/shade/shade9","sound/NPC/shade/shade10","sound/NPC/shade/shade11","sound/NPC/shade/shade12","sound/NPC/shade/shade13","sound/NPC/shade/shade14","sound/NPC/shade/shade15"]}}));id=id+1;}else{enemies[i]=[];}}});Server.getRoomEnemies=function(){var e=enemies[room.location.column+room.location.row*columns],started=new Date().getTime();for(var i=0;i<e.length;i++){e[i].lastTime=started;e[i].elapsedTime=0;}
return e;};Server.moveCharacter=function(l){};Server.attack=function(d){var es=enemies[room.location.column+room.location.row*columns];var row=character.location.row,column=character.location.column;if(d===CONSTANTS.DIRECTION.UP){row--;}else if(d===CONSTANTS.DIRECTION.LEFT){column--;}else if(d===CONSTANTS.DIRECTION.DOWN){row++;}else if(d===CONSTANTS.DIRECTION.RIGHT){column++;}
for(var i=0;i<es.length;i++){var l=es[i].location;if(l.row===row&&l.column===column){var thisRoom=room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column;es[i].damage(1,function(){var item=randomItem();character.statistics.experience.current+=this.statistics.experience.current;(roomItems[thisRoom]=roomItems[thisRoom]||[]).push(new Item({name:item[0]+" "+item[1],sounds:{move:["sound/inventory/coin"]},type:item[1],portrait:"items/"+item[0]+"-"+item[1]+".png",id:1,location:{column:column,row:row},statistics:{strength:{current:item[2],max:item[2]},defense:{current:item[2],max:item[2]},speed:{current:item[2],max:item[2]}},ground:{rows:3,columns:5,src:"drops.png",display:{column:Math.floor(Math.random()*5),row:Math.floor(Math.random()*3)}}}));items.events.invoke("drop");},function(){es.splice(es.indexOf(this),1);});}}};function randomItem(){var weight=["cloth","hide","leather","chain","steel"],part=["head","feet","hands","legs","chest"],item=["cloth","head"];while(item[0]==="cloth"&&item[1]==="head"){item[2]=Math.floor(Math.random()*weight.length);item[0]=weight[item[2]];item[1]=part[Math.floor(Math.random()*part.length)];}
return item;}
var roomItems=[];Server.getRoomItems=function(){return roomItems[room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column]||[];};return Server;}());var CONSTANTS={TILE:{WIDTH:48,HEIGHT:48,ROWS:7,COLUMNS:7,MIDDLE:{ROW:function(){return Math.floor(CONSTANTS.TILE.ROWS/2);},COLUMN:function(){return Math.floor(CONSTANTS.TILE.COLUMNS/2);}}},WIDTH:function(){return CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS;},HEIGHT:function(){return CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS;},WALL:{NONE:0,TOP:1,RIGHT:2,BOTTOM:4,LEFT:8,ALL:15},DIRECTION:{UP:0,LEFT:1,DOWN:2,RIGHT:3},INBETWEEN:function(){return canvas.width/2-((CONSTANTS.TILE.ROWS+2)*CONSTANTS.TILE.WIDTH)/2-20;},START:{X:function(){return canvas.width/2-CONSTANTS.WIDTH()/2;},Y:function(){return canvas.height/2-CONSTANTS.HEIGHT()/2;}}},tileset=new TileSet({columns:9,rows:16,src:"tiles.gif"}),canvas,context,background=loadImage("background.jpg"),character=Server.getCharacter(),contexts=[],room={location:Server.getCharacterRoomLocation(),events:new EventHandler()},items={list:Server.getRoomItems(),events:new EventHandler()},inventory_items=[],equipment_items={},enemies=[];
$(function(){canvas=$("#screen")[0];canvas.events=new EventHandler();context=canvas.getContext("2d");context.font="12px Times New Roman";attachEvent(canvas,"click",function(e){var bb=canvas.getBoundingClientRect();canvas.events.invoke("click",[{x:(e.pageX-bb.left)*(canvas.width/canvas.clientWidth),y:(e.pageY-bb.top)*(canvas.height/canvas.clientHeight)}]);});attachEvent(canvas,"mousemove",function(e){var bb=canvas.getBoundingClientRect();canvas.events.invoke("mousemove",[{x:(e.pageX-bb.left)*(canvas.width/canvas.clientWidth),y:(e.pageY-bb.top)*(canvas.height/canvas.clientHeight)}]);});var down=[];attachEvent(canvas,"keydown",function(e){if(!down[e.which]){canvas.events.invoke("keydown",e.which);down[e.which]=1;}
e.preventDefault();});attachEvent(canvas,"keyup",function(e){canvas.events.invoke("keyup",e.which);down[e.which]=0;e.preventDefault();});var tick=(function(){window.setTimeout=function(f,t){var id=index++;r[id]={f:f,t:t,r:t};return id;};window.setInterval=function(f,t){var id=index++;r[id]={f:f,t:t,r:t,i:true};return id;};window.setCatchup=function(f,t){var id=index++;r[id]={f:f,t:t,r:t,i:true,c:true};return id;};window.clearTimeout=function(id){delete r[id];};window.clearInterval=function(id){delete r[id];};var time=new Date().getTime(),r={},index=0;return function(){var now=new Date().getTime(),passed=now-time;time=now;for(var i in r){if(r.hasOwnProperty(i)){if((r[i].r-=passed)<=0){var f=r[i].f;if(r[i].i){if(r[i].c){while(r[i]&&(r[i].r<0)){r[i].r+=r[i].t;f&&f();}}else{r[i].r=r[i].t;f&&f();}}else{f&&f();delete r[i];}}}}};}());function frame(){requestAnimFrame(frame);tick();if(background&&background.complete){context.drawImage(background,0,0,canvas.width,canvas.height);}
canvas.events.invoke("draw");}
frame();});
$(function(){var tiles;room.events.attach("change",function(){tiles=Server.getTiles();});canvas.events.attach("draw",function(){context.strokeStyle="black";for(var i=0;i<CONSTANTS.TILE.ROWS;i++){for(var j=0;j<CONSTANTS.TILE.COLUMNS;j++){if(tileset.complete){var tile=tiles[j][i],sx=tile.column*tileset.width,sy=tile.row*tileset.height,dx=CONSTANTS.START.X()+j*CONSTANTS.TILE.WIDTH,dy=CONSTANTS.START.Y()+i*CONSTANTS.TILE.HEIGHT;context.drawImage(tileset.image,sx,sy,tileset.width,tileset.height,dx,dy,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}
context.strokeRect(CONSTANTS.START.X()+j*CONSTANTS.TILE.WIDTH,CONSTANTS.START.Y()+i*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}}});});
var Blood=(function(){function Blood(obj){var count=obj.count||500,colors=obj.colors||BLOOD_RED,max_speed=obj.speed||50,size=obj.size||5;for(var i=0;i<count;i++){var rad=2*Math.PI*Math.random(),speed=Math.random()*max_speed;particles.push({color:colors[Math.floor(colors.length*Math.random())],size:Math.ceil(size*Math.random()),location:{x:obj.location.x,y:obj.location.y},velocity:{x:Math.cos(rad)*speed,y:Math.sin(rad)*speed},room:{column:room.location.column,row:room.location.row}});}}
var stains=[],stains_canvas,stains_context,particles=[];$(function(){canvas.events.attach("draw",function(){for(var i=particles.length-1;i>=0;i--){var p=particles[i],l=p.location,v=p.velocity;if(Math.abs(v.x)+Math.abs(v.y)<1||l.x<=CONSTANTS.START.X()||l.y<=CONSTANTS.START.Y()||l.x>=CONSTANTS.START.X()+stains_canvas.width||l.y>=CONSTANTS.START.Y()+stains_canvas.height){particles.splice(i,1);var temp=stains[p.room.row][p.room.column].getContext("2d");temp.fillStyle=p.color;temp.fillRect(l.x-CONSTANTS.START.X(),l.y-CONSTANTS.START.Y(),p.size,p.size);}else{if(p.room.column===room.location.column&&p.room.row===room.location.row){context.fillStyle=p.color;context.fillRect(l.x,l.y,p.size,p.size);}
l.x+=v.x;l.y+=v.y;v.x/=2;v.y/=2;}}
context.drawImage(stains_canvas,CONSTANTS.START.X(),CONSTANTS.START.Y());});room.events.attach("change",function(){var row=stains[room.location.row]=(stains[room.location.row]||[]),column=row[room.location.column];if(!column){column=document.createElement("canvas");column.width=CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS;column.height=CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS;}
row[room.location.column]=stains_canvas=column;stains_context=column.getContext("2d");});});var BLOOD_RED=["rgba(102, 000, 000, 0.25)","rgba(220, 020, 060, 0.25)","rgba(139, 000, 000, 0.25)","rgba(128, 000, 000, 0.25)","rgba(204, 017, 000, 0.25)"];return Blood;}());
$(function(){var count=0;items.events.attach("drop",function(){items.list=Server.getRoomItems();while(count<items.list.length){var move=items.list[count].sounds.move;Sound.effect(move[Math.floor(Math.random()*move.length)]);count++;}});room.events.attach("change",function(){items.list=Server.getRoomItems();count=items.list.length;});canvas.events.attach("draw",function(){for(var i=items.list.length-1;i>=0;i--){var item=items.list[i],l=item.location,start=CONSTANTS.START,size=CONSTANTS.TILE;context.drawImage(items.list[i].portrait,start.X()+l.column*size.WIDTH,start.Y()+l.row*size.HEIGHT,size.WIDTH,size.HEIGHT);}});});
$(function(){var sx=canvas.width/2-CONSTANTS.WIDTH()/2,sy=canvas.height/2-CONSTANTS.HEIGHT()/2;canvas.events.attach("draw",function(){for(var i=0;i<enemies.length;i++){enemies[i].draw(context);}});room.events.attach("change",function(){enemies=Server.getRoomEnemies();moveEnemies();});character.events.attach("trymove",function(l){for(var i=0;i<enemies.length;i++){var e=enemies[i];if(l.row===e.location.row&&l.column===e.location.column&&e.statistics.health.current>0){l.collides=true;}}});function moveEnemies(){for(var i=enemies.length-1;i>=0;i--){var e=enemies[i];move(e);}}
function move(e){if(enemies.indexOf(e)!=-1){var action,moves=e.moves();if(moves===0){action=function(){e.wait(function(){move(e);});};}
while(moves>0&&character.statistics.health.current>0){moves--;var map=[],mg=new MazeGenerator(CONSTANTS.TILE.COLUMNS,CONSTANTS.TILE.ROWS),i;map.columns=CONSTANTS.TILE.COLUMNS;map.rows=CONSTANTS.TILE.ROWS;for(i=0;i<CONSTANTS.TILE.ROWS*CONSTANTS.TILE.COLUMNS;i++){map[i]=0;}
for(i=0;i<enemies.length;i++){if(e!==enemies[i]){if(enemies[i].statistics.health.current>0){var obs=enemies[i].location;map[obs.column+obs.row*CONSTANTS.TILE.COLUMNS]=CONSTANTS.WALL.ALL;}}}
if(e.statistics.health.current>0){var path=mg.getPath(map,e.location.column,e.location.row,character.location.column,character.location.row);if(path.length>2){var p=path[path.length-2];var h=(p.column-e.location.column)*CONSTANTS.TILE.WIDTH,v=(p.row-e.location.row)*CONSTANTS.TILE.HEIGHT;e.face(p.column,p.row);e.location.column=p.column;e.location.row=p.row;action=function(){e.moveBy(h,v,function(){e.face(character.location.column,character.location.row);move(e);});};}else if(Math.abs(character.location.column-e.location.column)+
Math.abs(character.location.row-e.location.row)===1){character.damage(1);e.face(character.location.column,character.location.row);action=function(){e.slash(function(){move(e);});};}else{action=function(){e.wait(function(){move(e);});};}}}
action&&action();}}});
$(function(){var walls,tile={column:6,row:11};room.events.attach("change",function(){walls=Server.getWalls();});character.events.attach("trymove",function(l){var mr=CONSTANTS.TILE.MIDDLE.ROW(),mc=CONSTANTS.TILE.MIDDLE.COLUMN();l.collides=l.collides||l.column===-1&&l.row===mr&&walls&CONSTANTS.WALL.LEFT||l.column===-1&&l.row!==mr;l.collides=l.collides||l.column===CONSTANTS.TILE.COLUMNS&&l.row===mr&&walls&CONSTANTS.WALL.RIGHT||l.column===CONSTANTS.TILE.COLUMNS&&l.row!==mr;l.collides=l.collides||l.row===-1&&l.column===mc&&walls&CONSTANTS.WALL.TOP||l.row===-1&&l.column!==mc;l.collides=l.collides||l.row===CONSTANTS.TILE.ROWS&&l.column===mc&&walls&CONSTANTS.WALL.BOTTOM||l.row===CONSTANTS.TILE.ROWS&&l.column!==mc;});function drawHorizontalWalls(){var sx=canvas.width/2-CONSTANTS.WIDTH()/2-CONSTANTS.TILE.WIDTH,sy=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,mid=Math.floor((CONSTANTS.TILE.ROWS+2)/2);for(var i=0;i<CONSTANTS.TILE.ROWS+2;i++){if(i!==mid||(walls&CONSTANTS.WALL.LEFT)){context.drawImage(tileset.image,tileset.width*tile.column,tileset.height*tile.row,tileset.width,tileset.height,sx,sy+i*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}
if(i!==mid||(walls&CONSTANTS.WALL.RIGHT)){context.drawImage(tileset.image,tileset.width*tile.column,tileset.height*tile.row,tileset.width,tileset.height,sx+CONSTANTS.WIDTH()+CONSTANTS.TILE.WIDTH,sy+i*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}}}
function drawVerticalWalls(){var sx=canvas.width/2-CONSTANTS.WIDTH()/2,sy=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,mid=Math.floor(CONSTANTS.TILE.COLUMNS/2);for(var i=0;i<CONSTANTS.TILE.COLUMNS;i++){if(i!==mid||(walls&CONSTANTS.WALL.TOP)){context.drawImage(tileset.image,tileset.width*tile.column,tileset.height*tile.row,tileset.width,tileset.height,sx+i*CONSTANTS.TILE.WIDTH,sy,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}
if(i!==mid||(walls&CONSTANTS.WALL.BOTTOM)){context.drawImage(tileset.image,tileset.width*tile.column,tileset.height*tile.row,tileset.width,tileset.height,sx+i*CONSTANTS.TILE.WIDTH,sy+CONSTANTS.TILE.HEIGHT+CONSTANTS.HEIGHT(),CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT);}}}
canvas.events.attach("draw",function(){drawHorizontalWalls();drawVerticalWalls();});});
$(function(){var walls=Server.getAllWalls(),alpha=0;setInterval(function(){alpha+=Math.PI/10;alpha%=(2*Math.PI);},100);canvas.events.attach("draw",function(){context.save();context.translate(canvas.width-CONSTANTS.INBETWEEN()-10,10);context.strokeStyle="black";context.fillStyle="rgba(255, 255, 255, 0.5)";context.fillRect(0,0,CONSTANTS.INBETWEEN(),CONSTANTS.INBETWEEN());var cellw=CONSTANTS.INBETWEEN()/walls.columns,cellh=CONSTANTS.INBETWEEN()/walls.rows;for(var i=0;i<walls.data.length;i++){var d=walls.data[i],column=i%walls.columns,row=Math.floor(i/walls.rows);if(d!==undefined){context.fillRect(cellw*column,cellh*row,cellw,cellh);}
if(d&CONSTANTS.WALL.TOP){context.strokeRect(cellw*column,cellh*row,cellw,1);}
if(d&CONSTANTS.WALL.RIGHT){context.strokeRect(cellw*column+cellw,cellh*row,1,cellh);}
if(d&CONSTANTS.WALL.BOTTOM){context.strokeRect(cellw*column,cellh*row+cellh,cellw,1);}
if(d&CONSTANTS.WALL.LEFT){context.strokeRect(cellw*column,cellh*row,1,cellh);}}
var cw=cellw/4,ch=cellh/4;context.fillStyle="rgba(255, 0, 0, "+((1+Math.sin(alpha))/4+0.5)+")";context.fillRect(room.location.column*cellw+cellw/2-cw/2,room.location.row*cellh+cellh/2-ch/2,cw,ch);context.restore();});room.events.attach("change",function(){walls.data[room.location.column+room.location.row*walls.columns]=Server.getWalls();}).invoke("change");});
$(function(){canvas.events.attach("draw",function(){character.draw(context);});canvas.events.attach("keydown",function(which){if(character.tween.isTweening()||character.statistics.health.current<=0)return;var moved=1,l={column:character.location.column,row:character.location.row,collides:false},horizontal=0,vertical=0;if(which===37){l.column--;character.display.row=CONSTANTS.DIRECTION.LEFT;horizontal=-CONSTANTS.TILE.WIDTH;}else if(which===38){l.row--;character.display.row=CONSTANTS.DIRECTION.UP;vertical=-CONSTANTS.TILE.HEIGHT;}else if(which===39){l.column++;character.display.row=CONSTANTS.DIRECTION.RIGHT;horizontal=CONSTANTS.TILE.WIDTH;}else if(which===40){l.row++;character.display.row=CONSTANTS.DIRECTION.DOWN;vertical=CONSTANTS.TILE.HEIGHT;}else{moved=0;if(which===32){Server.attack(character.display.row);character.slash();}}
if(moved){character.events.invoke("trymove",l);if(!l.collides){var change=true;if(l.column===-1){room.location.column--;}else if(l.column===CONSTANTS.TILE.COLUMNS){room.location.column++;}else if(l.row===-1){room.location.row--;}else if(l.row===CONSTANTS.TILE.ROWS){room.location.row++;}else{change=false;}
Server.moveCharacter(l);character.location.column=(l.column+CONSTANTS.TILE.COLUMNS)%CONSTANTS.TILE.COLUMNS;character.location.row=(l.row+CONSTANTS.TILE.ROWS)%CONSTANTS.TILE.ROWS;if(change){room.events.invoke("change");}else{character.moveBy(horizontal,vertical);}}}});});
$(function(){var sx=canvas.width/2-CONSTANTS.WIDTH()/2,sy=canvas.height/2-CONSTANTS.HEIGHT()/2;var foreground=loadImage("health/foreground_gray.png"),background=loadImage("health/background.png");canvas.events.attach("draw",function(){var h_rat=character.statistics.health.current/character.statistics.health.max,exp=character.statistics.experience.current/character.statistics.experience.max;drawBar("red",10,sy-CONSTANTS.TILE.HEIGHT,CONSTANTS.INBETWEEN(),25,h_rat);drawBar("blue",10,sy-CONSTANTS.TILE.HEIGHT+35,CONSTANTS.INBETWEEN(),25,1);drawBar("green",10,sy-CONSTANTS.TILE.HEIGHT+70,CONSTANTS.INBETWEEN(),25,exp);for(var i=0;i<enemies.length;i++){var l=enemies[i].location,h=enemies[i].statistics.health;if(h.current>0){drawBar("red",sx+5+l.column*CONSTANTS.TILE.WIDTH+l.x,sy+l.row*CONSTANTS.TILE.HEIGHT+l.y,CONSTANTS.TILE.WIDTH-10,10,h.current/h.max);}}});function drawBar(color,x,y,w,h,r){r=Math.min(Math.max(0,r),1);context.fillStyle=color;var rw=w/background.width,rh=h/background.height;context.drawImage(background,x,y,w,h);context.fillRect(x+12*rw,y+8*rh,(w-24*rw)*r,15*rh);context.drawImage(foreground,x,y,w,h);}});
$(function(){canvas.events.attach("keydown",function(key){if(key===17){var index=inventory_items.indexOf(undefined);if(index!==-1){for(var i=0;i<items.list.length;i++){var item=items.list[i];if(item.location.column===character.location.column&&item.location.row===character.location.row){inventory_items[index]=item;Sound.effect(item.sounds.move);items.list.splice(i,1);break;}}}}
if(key===73){inventory_items.visible=!inventory_items.visible;}else{inventory_items.visible=0;}});var start={x:0,y:100},margin=5,cellwidth=CONSTANTS.TILE.WIDTH,cellheight=CONSTANTS.TILE.HEIGHT,rows=4,columns=6,background,titlesize=24,width=(cellwidth+margin*2)*columns,height=margin*2+titlesize+(cellheight+margin*2)*rows;inventory_items.visible=0;loadImage("window/texture.png",function(img){background=context.createPattern(img,"repeat");});var menu={"Equip / Use":function(c){var item,index=inventory_items.indexOf(c),i;inventory_items[index]=undefined;if(equipment_items[c.type].item){item=equipment_items[c.type].item;for(i in item.statistics){character.statistics[i].current-=item.statistics[i].current;character.statistics[i].max-=item.statistics[i].max;}
inventory_items[index]=item;Sound.effect(item.sounds.move);}
item=c;for(i in item.statistics){character.statistics[i].current+=item.statistics[i].current;character.statistics[i].max+=item.statistics[i].max;}
equipment_items[c.type].item=c;Sound.effect(item.sounds.move);},"Drop":function(c){inventory_items[inventory_items.indexOf(c)]=undefined;c.location.row=character.location.row;c.location.column=character.location.column;items.list.push(c);Sound.effect(c.sounds.move);},"Destroy":function(c){inventory_items[inventory_items.indexOf(c)]=undefined;Sound.effect(c.sounds.move);}};for(var i=0;i<rows;i++){for(var j=0;j<columns;j++){var x=margin+(margin*2+cellwidth)*j,y=margin*3+titlesize+(margin*2+cellheight)*i;inventory_items.push(undefined);contexts.push({column:j,row:i,x:x,y:y,width:cellwidth,height:cellheight,contains:function(l){if(inventory_items.visible){var x=this.x+start.x,y=this.y+start.y,r=x+this.width,b=y+this.height;if(l.x>=x&&l.y>=y&&l.x<=r&&l.y<=b){var item=inventory_items[this.column+this.row*columns];if(item){return{context:item,menu:menu};}}}}});}}
canvas.events.attach("draw",function(){if(inventory_items.visible){start.x=canvas.width/2-width/2;start.y=canvas.height/2-height/2;context.save();context.globalAlpha=0.8;context.translate(start.x,start.y);context.strokeStyle="black";context.fillStyle=background;context.fillRect(0,0,width,height);context.strokeRect(0,0,width,height);context.strokeRect(margin,margin,width-margin*2,titlesize);for(var i=0;i<rows;i++){for(var j=0;j<columns;j++){var x=margin+(margin*2+cellwidth)*j,y=margin*3+titlesize+(margin*2+cellheight)*i,ii=inventory_items[j+i*columns];context.strokeRect(x,y,cellwidth,cellheight);if(ii){context.drawImage(ii.portrait,x,y,cellwidth,cellheight);}}}
context.strokeStyle="white";context.textBaseline="middle";context.strokeText("Inventory",margin*2,margin+titlesize/2,width-margin*2);context.restore();}});});
$(function(){var width=296,height=325,background,margin=5,titlesize=22,start={x:400,y:0};equipment_items.visible=0;loadImage("window/texture.png",function(img){background=context.createPattern(img,"repeat");});equipment_items.head={rectangle:{x:width/2-32,y:margin*3+titlesize,width:64,height:64},empty:loadImage("items/head.png")};equipment_items.neck={rectangle:{x:width/2-64-margin*2,y:margin*3+titlesize+equipment_items.head.rectangle.height-32,width:32,height:32},empty:loadImage("items/neck.png")};equipment_items.chest={rectangle:{x:width/2-48,y:margin*5+titlesize+equipment_items.head.rectangle.height,width:96,height:86},empty:loadImage("items/chest.png")};equipment_items.mainhand={rectangle:{x:margin,y:margin*5+titlesize+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/mainhand.png")};equipment_items.offhand={rectangle:{x:width-margin-80,y:margin*5+titlesize+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/offhand.png")};equipment_items.legs={rectangle:{x:width/2-56,y:margin*7+titlesize+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:112,height:112},empty:loadImage("items/legs.png")};equipment_items.feet={rectangle:{x:margin,y:margin*7+titlesize+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/feet.png")};equipment_items.hands={rectangle:{x:width-72-margin,y:margin*7+titlesize+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/hands.png")};equipment_items.rightring={rectangle:{x:width/2+margin*3+equipment_items.legs.rectangle.width/2,y:margin*9+titlesize+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")};equipment_items.leftring={rectangle:{x:width/2-margin*3-equipment_items.legs.rectangle.width/2-30,y:margin*9+titlesize+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")};var menu={"Unequip":function(c){var index=inventory_items.indexOf(undefined);if(index!==-1){var item=c.item;for(var i in item.statistics){character.statistics[i].current-=item.statistics[i].current;character.statistics[i].max-=item.statistics[i].max;}
inventory_items[index]=c.item;Sound.effect(item.sounds.move);delete c.item;}}};for(var i in equipment_items){contexts.push({item:equipment_items[i],contains:function(l){var ei=this.item;if(equipment_items.visible&&ei.item){var x=start.x+ei.rectangle.x,y=start.y+ei.rectangle.y,b=y+ei.rectangle.height,r=x+ei.rectangle.width;if(l.x>=x&&l.y>=y&&l.x<=r&&l.y<=b){return{context:ei,menu:menu};}}}});}
canvas.events.attach("keydown",function(keycode){if(keycode===69){equipment_items.visible=!equipment_items.visible;}else{equipment_items.visible=0;}});canvas.events.attach("draw",function(){if(equipment_items.visible){start.x=canvas.width/2-width/2;start.y=canvas.height/2-height/2;context.save();context.globalAlpha=0.8;context.translate(start.x,start.y);context.strokeStyle="black";context.fillStyle=background;context.fillRect(0,0,width,height);context.strokeRect(margin,margin,width-margin*2,titlesize);context.strokeRect(0,0,width,height);for(var i in equipment_items){var ei=equipment_items[i],rectangle=ei.rectangle,empty=ei.empty,item=ei.item;if(rectangle){if(item){context.drawImage(item.portrait,rectangle.x,rectangle.y,rectangle.width,rectangle.height);}else if(empty.complete){context.drawImage(empty,rectangle.x,rectangle.y,rectangle.width,rectangle.height);}
context.strokeRect(rectangle.x,rectangle.y,rectangle.width,rectangle.height);}}
context.strokeStyle="white";context.textBaseline="middle";context.strokeText("Equipment",margin+5,margin+titlesize/2,width);context.restore();}});});
$(function(){var width=300,titlesize=22,margin=5,start={x:0,y:0},background,statistics=Object.keys(new Statistics()),visible=0,height=titlesize+margin*2+width/2+statistics.length*(margin*2+titlesize),location={x:0,y:0},mousemove=0;loadImage("window/texture.png",function(img){background=context.createPattern(img,"repeat");});canvas.events.attach("mousemove",function(l){location=l;mousemove=1;});canvas.events.attach("keydown",function(keycode){if(keycode===83){visible=!visible;}else{visible=0;}
mousemove=0;});canvas.events.attach("draw",function(){context.save();context.globalAlpha=0.8;if(visible){drawCharacterStatistics();}else if(!contexts.contextmenu){drawItemStatistics(getHover());if(mousemove&&!equipment_items.visible&&!inventory_items.visible){var column=Math.floor((location.x-CONSTANTS.START.X())/CONSTANTS.TILE.WIDTH),row=Math.floor((location.y-CONSTANTS.START.Y())/CONSTANTS.TILE.HEIGHT);for(var i=0;i<items.list.length;i++){var item=items.list[i],l=item.location;if(l.column===column&&l.row===row){drawItemStatistics(item);break;}}}}
context.restore();});function drawItemStatistics(item){if(item){var equipped,final_width=width;if(equipment_items.visible){item=item.item;}else{equipped=equipment_items[item.type].item;if(equipped){final_width*=2;}}
context.save();context.translate(clamp(location.x,0,canvas.width-final_width),clamp(location.y,0,canvas.height-height));context.strokeStyle="black";context.fillStyle=background;context.fillRect(0,0,final_width,height);context.strokeRect(0,0,final_width,height);drawStatistics(item);if(equipped){context.translate(width,0);drawStatistics(equipped);}
context.restore();}}
function getHover(){for(var i=0;i<contexts.length;i++){var context=contexts[i].contains(location);if(context){return context.context;}}
return false;}
function drawCharacterStatistics(){start.x=canvas.width/2-width/2;start.y=canvas.height/2-height/2;context.save();context.translate(start.x,start.y);context.strokeStyle="black";context.fillStyle=background;context.fillRect(0,0,width,height);context.strokeRect(0,0,width,height);drawStatistics(character);context.restore();}
function drawStatistics(obj){context.strokeRect(margin,margin,width-margin*2,titlesize);var cellwidth=width/2,cellheight=cellwidth;context.strokeRect(margin,margin*3+titlesize,cellwidth-margin*2,cellheight-margin*2);context.strokeRect(width-cellwidth+margin,margin*3+titlesize,cellwidth-margin*2,cellheight-margin*2);if(obj.portrait.complete){context.drawImage(obj.portrait,width-cellwidth+margin,margin*3+titlesize,cellwidth-margin*2,cellwidth-margin*2);}
context.fillStyle="white";context.textAlign='right';context.textBaseline="bottom";context.fillText(obj.name,cellwidth-margin*2,titlesize+cellheight,cellwidth);context.textBaseline="middle";cellwidth=width/3;for(var i=0;i<statistics.length;i++){context.textAlign='right';context.fillText(statistics[i][0].toUpperCase()+statistics[i].substring(1),cellwidth-margin*2,titlesize+margin*3+cellheight+i*(margin*2+titlesize)+titlesize/2,width);context.strokeRect(margin,titlesize+margin*3+cellheight+i*(margin*2+titlesize),cellwidth-margin*2,titlesize);context.textAlign='center';context.fillText(obj.statistics[statistics[i]].max,cellwidth+cellwidth/2,titlesize+margin*3+cellheight+i*(margin*2+titlesize)+titlesize/2,cellwidth-margin*2);context.strokeRect(margin+cellwidth,titlesize+margin*3+cellheight+i*(margin*2+titlesize),cellwidth-margin*2,titlesize);context.fillText(obj.statistics[statistics[i]].current,2*cellwidth+cellwidth/2,titlesize+margin*3+cellheight+i*(margin*2+titlesize)+titlesize/2,cellwidth-margin*2);context.strokeRect(margin+2*cellwidth,titlesize+margin*3+cellheight+i*(margin*2+titlesize),cellwidth-margin*2,titlesize);}
context.textAlign='left';context.fillText("Statistics",margin*2,margin+titlesize/2,width);}});
$(function(){var contextmenu,padding=5,location,cellheight=padding*2+12,height,width,highlight;canvas.events.attach("click",function(l){if(contextmenu){var options=Object.keys(contextmenu.menu);contextmenu.menu[options[highlight]](contextmenu.context);contexts.contextmenu=contextmenu=0;}else{highlight=0;contextmenu=0;location=l;for(var i=0;i<contexts.length&&!contextmenu;i++){contextmenu=contexts[i].contains(l);}
contexts.contextmenu=contextmenu;location.x-=5;location.y-=5;}});canvas.events.attach("keydown",function(){contexts.contextmenu=contextmenu=0;});canvas.events.attach("mousemove",function(l){if(contextmenu&&(l.x<location.x||l.y<location.y||l.x>=location.x+width||l.y>=location.y+height)){contexts.contextmenu=contextmenu=0;}else if(contextmenu){highlight=Math.floor((l.y-location.y)/cellheight);}});canvas.events.attach("draw",function(){if(contextmenu){var options=Object.keys(contextmenu.menu),max=0,i;for(i=0;i<options.length;i++){width=context.measureText(options[i]).width;if(width>max){max=width;}}
height=cellheight*options.length;context.fillStyle="gray";context.strokeStyle="black";context.textbaseline="textBaseline";max+=padding*2;width=max;context.fillRect(location.x,location.y,max,height);context.fillStyle="lightgray";context.fillRect(location.x,location.y+cellheight*highlight,width,cellheight);for(i=0;i<options.length;i++){context.strokeText(options[i],location.x+padding,location.y+(i+1)*cellheight-cellheight/2,max);}}});});