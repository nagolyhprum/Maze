var Tween=function(){function e(){this.queue=[],this.locked=0}return e.prototype.push=function(e){return this.queue.push(e),this.process()},e.prototype.clear=function(){for(var e=0;e<this.queue.length;e++)this.queue[e].isCleared=!0;return this},e.prototype.process=function(){var e=this;if(!e.locked&&e.queue.length){e.locked=1;var t=e.queue[0],n=setCatchup(function(){if(t.isCleared||t.change()===!1)n&&clearInterval(n),e.queue.shift(),t.complete&&t.complete(),e.locked=0,e.process()},t.isCleared?0:t.interval);t.init&&t.init()}return e},e.prototype.isTweening=function(){return this.locked},e}();var EventHandler=function(){function e(e){this.events={};if(e&&e.events)for(var t in e.events)this.events[t]=e.events[t].slice(0)}return e.prototype.invoke=function(e,t){t=t instanceof Array?t:[t];var n=this.events[e];if(!n)return this;for(var r=0;r<n.length;r++)n[r].apply(undefined,t);return this},e.prototype.attach=function(e,t){return(this.events[e]=this.events[e]||[]).push(t),this},e.prototype.detach=function(e,t){var n=this.events[e];if(!n)return this;for(var r=0;r<n.length;r++)if(n[r]===t){n.splice(r,1);break}return this},e}();function ajax(e,t,n){var r=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),i="";for(var s in t)i&&(i+="&"),i+=s+"="+t[s];e+="?"+i,r.onreadystatechange=function(){r.readyState==4&&r.status==200&&n&&n(JSON.parse(r.responseText))},r.open("GET",e,!0),r.send()}function sendDamage(e,t){var n={column:character.location.column+e.column,row:character.location.row+e.row},r=Math.abs(t.area),i=t.attack||t.action;while(n.column>=0&&n.row>=0&&n.column<CONSTANTS.TILE.COLUMNS&&n.row<CONSTANTS.TILE.ROWS&&r>0){for(var s=0;s<enemies.length;s++){var o=enemies[s];if(o.statistics.getCurrent("health")>0&&o.location.column===n.column&&o.location.row===n.row){Server.attack(enemies,s,i!=="spellcast");return}}n.column+=e.column,n.row+=e.row,r--}}function getDrawingOrder(e){return{legs:10,feet:11,chest:12,hands:13,head:14,mainhand:15,offhand:16}[e]}function unequip(e,t){var n=equipment_items[e].item;if(t!==-1){if(n){var r=Statistics.getStatisticNames();for(var i=0;i<r.length;i++){var s=r[i];character.statistics[s].current-=n.statistics[s].current,character.statistics[s].max-=n.statistics[s].max}var o=getDrawingOrder(e);character.slash[o]=undefined,character.walk[o]=undefined,character.bow[o]=undefined,character.spellcast[o]=undefined,character.thrust[o]=undefined,character.hurt[o]=undefined,inventory_items[t]=n,Sound.effect(n.sounds.move),equipment_items[e].item=undefined}}else alert("You have no room in your inventory for this item.")}function equip(e,t){var n=Statistics.getStatisticNames();for(var r=0;r<n.length;r++){var i=n[r];character.statistics[i].current+=e.statistics[i].current,character.statistics[i].max+=e.statistics[i].max}var s=getDrawingOrder(e.weight===1&&e.type==="mainhand"?"offhand":e.type);e.slash&&(character.slash[s]=e.slash),e.walk&&(character.walk[s]=e.walk),e.bow&&(character.bow[s]=e.bow),e.spellcast&&(character.spellcast[s]=e.spellcast),e.thrust&&(character.thrust[s]=e.thrust),e.hurt&&(character.hurt[s]=e.hurt),inventory_items[inventory_items.indexOf(e)]=null,equipment_items[t].item=e,Sound.effect(e.sounds.move)}function attachEvent(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n}function detachEvent(e,t,n){e.addEventListener?e.removeEventListener(t,n,!1):e.detachEvent?e.detachEvent("on"+t,n):e["on"+t]=null}function clamp(e,t,n){return Math.min(Math.max(e,t),n)}function TileSet(e){var t=this;e=e||{},t.rows=e.rows||1,t.columns=e.columns||1,e.location=e.location||{},t.location={row:e.location.row||0,column:e.location.column||0,x:e.location.x||0,y:e.location.y||0},e.display=e.display||{},t.display={row:e.display.row||0,column:e.display.column||0},t.src=e.src,this.image=loadImage(e.src,function(e){t.width=e.width/t.columns,t.height=e.height/t.rows,t.complete=1})}function getSign(e){return e?e/Math.abs(e):0}function tileify(e){if(e){for(var t=0;t<e.length;t++)e[t]=new TileSet(e[t]);return e}return[]}function Character(e){this.tween=new Tween,e=e||{},this.events=new EventHandler,this.attackstyle=e.attackstyle||"slash",this.walk=tileify(e.walk),this.bow=tileify(e.bow),this.spellcast=tileify(e.spellcast),this.thrust=tileify(e.thrust),this.slash=tileify(e.slash),this.hurt=tileify(e.hurt),this.active=this.walk,this.id=e.id,this.name=e.name,this.portrait=loadImage(e.portrait),e.location=e.location||{},this.level=e.level||1,this.location={column:e.location.column||0,row:e.location.row||0,x:e.location.x||0,y:e.location.y||0},e.display=e.display||{},this.display={row:e.display.row||0,column:e.display.column||0},this.statistics=new Statistics(e.statistics),e.sounds=e.sounds||{},this.sounds={slash:e.sounds.slash||[],hurt:e.sounds.hurt||[]}}function Item(e){e=e||{},e.location=e.location||{},e.walk&&(this.walk=new TileSet(e.walk)),e.spellcast&&(this.spellcast=new TileSet(e.spellcast)),e.bow&&(this.bow=new TileSet(e.bow)),e.slash&&(this.slash=new TileSet(e.slash)),e.thrust&&(this.thrust=new TileSet(e.thrust)),this.area=e.area||1,this.attack=e.attack||"slash",this.location={row:e.location.row||0,column:e.location.column||0,x:e.location.x||0,y:e.location.y||0},this.weight=e.weight||0,this.type=e.type,this.portrait=loadImage(e.portrait),this.statistics=new Statistics(e.statistics),this.id=e.id,this.name=e.name,e.sounds=e.sounds||{},this.sounds={move:e.sounds.move||[]}}function generateText(e){var t=document.createElement("canvas"),n=t.getContext("2d"),r=0,i=0,s=e.font||n.font;n.font=s,text=e.text.split("\n");while(r<text.length){var o=n.measureText(text[r]).width,u=0;while(o>e.width){var a=text[r],f=a.lastIndexOf(" ");if(f===-1)break;var l=a.substring(f+1),c=a.substring(0,f);text[r]=c,u>0?text[r+1]=l+" "+text[r+1]:text.splice(r+1,0,l),u++,o=n.measureText(c).width}r++,o>i&&(i=o)}var h=parseInt(s,10);t.width=i,t.height=text.length*h+h/3,n.font=s,n.fillStyle=e.color||"black",n.textBaseline="top",n.textAlign="left";for(var p=0;p<text.length;p++)n.fillText(text[p],0,p*h,e.width);return t}(function(){var e={};window.lock=function(t,n){e[t]||(e[t]=[],e[t].allowed=0),e[t].push(n),unlock(t,0)},window.unlock=function(t,n){e[t]||(e[t]=[],e[t].allowed=0),e[t].allowed+=n;for(var r=0;e[t].allowed&&e[t].length;r++)e[t].splice(0,1)[0](),e[t].allowed--}})(),String.prototype.endsWith=function(e){return this.indexOf(e,this.length-e.length)!==-1};var Sound=function(){var e=new Audio,t=[],n={},r={};return e.canPlayType&&(e.canPlayType("audio/mpeg;").replace("no","")&&t.push(".mp3"),e.canPlayType("audio/wav;").replace("no","")&&t.push(".wav"),e.canPlayType("audio/ogg;").replace("no","")&&t.push(".ogg")),r.effect=function(e,i){var s=n[e];s||(s=n[e]=[]);var o,u=0;for(var a=0;a<s.length&&!o;a++)s[a].paused&&s[a].canplay&&(o=s[a]);o?o.play():(o=new Audio,o.autoplay=!0,s.push(o),attachEvent(o,"canplaythrough",function(){this.canplay=!0}),o.src=r.root+e+t[u],u+=1,attachEvent(o,"error",function(){u<t.length&&(o.src=r.root+e+t[u],u+=1)}));var f=function(){i&&i(),detachEvent(this,"ended",f)};return attachEvent(o,"ended",f),function(){o.autoplay=!1,o.pause()}},r.music=function(e){var t,n=function(){t=Sound.effect(e,n)};return n(),function(){t()}},r.root="./",r}();Sound.root="audio/",Sound.music("music/dungeon");var loadImage=function(){var e={},t={};return function(n,r){if(n===undefined){console.log("undefined?");return}n=loadImage.root+n;var i=e[n],s=t[n];return i||(i=e[n]=new Image,i.src=n),r&&(i.complete?r(i):s?s.attach("load",r):(s=t[n]=new EventHandler,s.attach("load",r),attachEvent(i,"load",function(){t[n].invoke("load",[i])}))),i}}();loadImage.root="images/",TileSet.prototype.draw=function(e,t,n,r,i){e.drawImage(this.image,this.display.column*this.width,this.display.row*this.height,this.width,this.height,t,n,r,i)};var $=function(){function t(){return document.body&&document.body.readyState==="complete"}function n(n){var r=typeof n;return r==="function"?t()?(n(),!0):(e.attach("load",n),!1):r==="string"?document.querySelectorAll(n):!1}var e=new EventHandler;return t()?e.invoke("load"):attachEvent(window,"load",function(){e.invoke("load")}),n}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),Statistics=function(){var e=["health","energy","experience","strength","defense","intelligence","resistance","speed"],t=function(t){t=t||{};for(var n=0;n<e.length;n++){var r=e[n];t[r]=t[r]||{},this[r]={max:t[r].max||0,current:t[r].current||0}}this.duration=t.duration,this._add=[],this._multiply=[]};return t.getStatisticNames=function(){return e},t.prototype.remove=function(e){var t=this._add.indexOf(e);t!==-1&&this._add.splice(t,1),t=this._multiply.indexOf(e),t!==-1&&this._multiply.splice(t,1)},t.prototype.getMax=function(e){var t=this[e].max,n=0;for(;n<this._add.length;n++)t+=this._add[n][e].max;for(n=0;n<this._multiply.length;n++)t+=t*this._multiply[n][e].max;return t},t.prototype.getCurrent=function(e){var t=this[e].current,n=0;for(;n<this._add.length;n++)t+=this._add[n][e].current;for(n=0;n<this._multiply.length;n++)t+=t*this._multiply[n][e].current;return t},t.prototype.add=function(t,n){if(n&&t.duration===-1)for(var r=0;r<e.length;r++)this[e[r]].current=Math.min(t[e[r]].current+this[e[r]].current,this[e[r]].max);else this._add.push(t)},t.prototype.multiply=function(e){this._multiply.push(e)},t}();Character.prototype.draw=function(e){for(var t=0;t<this.active.length;t++){var n=this.active[t];n&&n.complete&&e.drawImage(n.image,this.display.column*n.width,this.display.row*n.height,n.width,n.height,CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+this.location.x,CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.HEIGHT+this.location.y,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}};var SPEED=500;Character.prototype.timeToMove=function(){return Math.ceil(SPEED/this.statistics.speed.current*CONSTANTS.TILE.WIDTH)},Character.prototype.moves=function(){var e=(new Date).getTime(),t=this.timeToMove(),n;return this.elapsedTime+=e-this.lastTime,this.lastTime=e,n=Math.floor(this.elapsedTime/t),this.elapsedTime=this.elapsedTime%t,n};var WALK=["sound/walk/stepstone_1","sound/walk/stepstone_2","sound/walk/stepstone_3","sound/walk/stepstone_4","sound/walk/stepstone_5","sound/walk/stepstone_6","sound/walk/stepstone_7","sound/walk/stepstone_8"];Character.prototype.moveBy=function(e,t,n){var r=this;this.tween.push({init:function(){Sound.effect(WALK[Math.floor(WALK.length*Math.random())]),r.location.x=-e,r.location.y=-t},change:function(){return r.location.x+=getSign(e),r.location.y+=getSign(t),r.display.column=Math.max((r.display.column+1)%r.active[0].columns,1),Math.abs(r.location.x)+Math.abs(r.location.y)!==0},interval:SPEED/this.statistics.speed.current,complete:function(){r.display.column=r.location.x=r.location.y=0,n&&n()}})},Character.prototype.attack=function(e,t){var n=this,r=-1;Sound.effect(this.sounds.slash[Math.floor(this.sounds.slash.length*Math.random())]),this.tween.push({init:function(){n.display.column=0,n.active=n[n===character&&equipment_items.mainhand.item?e||equipment_items.mainhand.item.attack:e||n.attackstyle]},change:function(){return r++,n.display.column=Math.floor(r/CONSTANTS.TILE.WIDTH*n.active[0].columns),r!==CONSTANTS.TILE.WIDTH},interval:SPEED/this.statistics.speed.current,complete:function(){n.active=n.walk,n.display.column=0,t&&t()}})},Character.prototype.face=function(e,t){Math.abs(this.location.column-e)>Math.abs(this.location.row-t)?this.location.column>e?this.display.row=CONSTANTS.DIRECTION.LEFT:this.location.column<e&&(this.display.row=CONSTANTS.DIRECTION.RIGHT):this.location.row>t?this.display.row=CONSTANTS.DIRECTION.UP:this.location.row<t&&(this.display.row=CONSTANTS.DIRECTION.DOWN)};var BLOOD=["sound/blood/blood1","sound/blood/blood2","sound/blood/blood3","sound/blood/blood4"];Character.prototype.damage=function(e,t,n){if(e>0){this===character?addBehavior("Damage","Received",e):addBehavior("Damage","Dealt",e);var r=this.statistics;if(r.getCurrent("health")>0){Sound.effect(BLOOD[Math.floor(BLOOD.length*Math.random())]),new Blood({location:{x:CONSTANTS.START.X()+this.location.column*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.WIDTH/2,y:CONSTANTS.START.Y()+this.location.row*CONSTANTS.TILE.WIDTH+CONSTANTS.TILE.HEIGHT/2}}),Sound.effect(this.sounds.hurt[Math.floor(this.sounds.hurt.length*Math.random())]),r.health.current-=e;if(r.getCurrent("health")<=0){var i=this;t&&t.call(i),i.die(function(){i===character&&(room.location.column=0,room.location.row=0,character.statistics.health.current=character.statistics.health.max,character.statistics.energy.current=character.statistics.energy.max,character.display.row=CONSTANTS.DIRECTION.DOWN,character.display.column=0,character.location.column=0,character.location.row=0,character.active=character.walk,addBehavior("Character","Deaths"),room.events.invoke("change")),n&&n()})}}}},Character.prototype.die=function(e){var t=this;this.tween.push({init:function(){t.active=t.hurt,t.display={row:0,column:0}},change:function(){return t.display.column=t.display.column+1,t.display.column!==t.active[0].columns},interval:100,complete:function(){e&&e.call(t)}})},Character.prototype.wait=function(e){this.tween.push({change:function(){return!1},interval:10,complete:e})},Character.prototype.getDirection=function(){var e={column:0,row:0},t=this.display.row;return t===CONSTANTS.DIRECTION.UP?e.row--:t===CONSTANTS.DIRECTION.RIGHT?e.column++:t===CONSTANTS.DIRECTION.DOWN?e.row++:t===CONSTANTS.DIRECTION.LEFT&&e.column--,e};var cid=1,Server=function(){function t(e,t){var s=Math.random();return s>.5?i(e,t):s>=0?r(e,t):n(e,t)}function n(e,t){return i(e,t)}function r(e,t){var n=[{portrait:"buckler",weight:1,strength:0,defense:5,speed:0,name:"Buckler",walk:{src:"walk/WEAPON_shield_cutout_body.png",rows:4,columns:9}},{attack:"slash",portrait:"dagger",weight:2,strength:5,defense:0,speed:0,name:"Dagger",area:1,slash:{src:"slash/WEAPON_dagger.png",rows:4,columns:6}},{attack:"bow",portrait:"shortbow",weight:3,strength:3,defense:0,speed:3,name:"Short Bow",area:Math.max(CONSTANTS.TILE.ROWS,CONSTANTS.TILE.COLUMNS),bow:{src:"bow/WEAPON_bow.png",rows:4,columns:13}},{attack:"spellcast",portrait:"wand",weight:2,strength:0,defense:0,speed:0,energy:5,intelligence:10,name:"Wand",area:-1,spellcast:{src:"spellcast/HEAD_skeleton_eye_glow.png",rows:4,columns:6}},{attack:"thrust",portrait:"longsword",weight:4,strength:10,defense:0,speed:0,energy:0,name:"Long Sword",area:2,thrust:{src:"thrust/WEAPON_spear.png",rows:4,columns:8}}],r=n[Math.floor(Math.random()*n.length)];return new Item({attack:r.attack,name:r.name,area:r.area,weight:r.weight,type:"mainhand",portrait:"items/"+r.portrait+".png",id:1,slash:r.slash,walk:r.walk,thrust:r.thrust,bow:r.bow,spellcast:r.spellcast,statistics:{strength:{current:r.strength,max:r.strength},intelligence:{current:r.intelligence,max:r.intelligence},defense:{current:r.defense,max:r.defense},speed:{current:r.speed,max:r.speed},energy:{current:r.energy,max:r.energy}},sounds:{move:["sound/inventory/coin"]},location:{column:e,row:t}})}function i(e,t){var n=["cloth","hide","leather","chain","steel"],r=["head","feet","hands","legs","chest"],i=["cloth","head"];while(i[0]==="cloth"&&i[1]==="head")i[2]=Math.floor(Math.random()*n.length),i[0]=n[i[2]],i[1]=r[Math.floor(Math.random()*r.length)];return new Item({slash:{src:"slash/"+i[1]+".png",rows:4,columns:6},walk:{src:"walk/"+i[1]+".png",rows:4,columns:9},thrust:{src:"thrust/"+i[1]+".png",rows:4,columns:8},bow:{src:"bow/"+i[1]+".png",rows:4,columns:13},spellcast:{src:"spellcast/"+i[1]+".png",rows:4,columns:7},name:i[0]+" "+i[1],sounds:{move:["sound/inventory/coin"]},type:i[1],portrait:"items/"+i[0]+"-"+i[1]+".png",id:1,location:{column:e,row:t},statistics:{defense:{current:i[2]+1,max:i[2]+1},speed:{current:4-i[2],max:4-i[2]}}})}var e={};e.healEnergy=function(){ajax("php/healEnergy.php",{cid:cid})},e.getSkillMapping=function(e){ajax("php/getSkillMapping.php",{cid:cid},function(t){for(var n=0;n<t.length;n++)if(t[n])for(var r=0;r<skills.length;r++)if(t[n]===skills[r].id){t[n]=skills[r];break}e(t)})},e.setSkillIndex=function(e,t,n){ajax("php/setSkillIndex.php",{sid:e,index:t,cid:cid},n)},e.getEquipment=function(e){ajax("php/getEquipment.php",{cid:cid},e)},e.equipItem=function(e,t){ajax("php/equipItem.php",{iid:e,cid:cid},t)},e.getItemsInInventory=function(e){ajax("php/getItemsInInventory.php",{cid:cid},e)},e.pickupItem=function(e){ajax("php/pickupItem.php",{cid:cid},e)},e.moveEnemies=function(e){ajax("php/moveEnemy.php",{cid:cid},e)},e.sendDamage=function(t,n){var r,i,o=room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column;ajax("php/sendDamage.php",{cid:cid,direction:character.display.row,index:t},function(t){for(r=0;r<t.enemies.length;r++)for(i=0;i<enemies.length;i++)t.enemies[r].id===enemies[i].id&&enemies[i].damage(t.enemies[r].damage);t.items&&e.getRoomItems(function(e){s=e,items.events.invoke("drop")}),n&&n()})},e.getTiles=function(){var e=[],t;for(var n=0;n<CONSTANTS.TILE.ROWS;n++){e.push(t=[]);for(var r=0;r<CONSTANTS.TILE.COLUMNS;r++)t.push({row:11,column:0})}return e},e.getWalls=function(e){ajax("php/getWalls.php",{cid:cid},e)},e.getAllWalls=function(e){ajax("php/getAllWalls.php",{cid:cid},e)},e.getCharacterRoomLocation=function(e){ajax("php/getCharacterRoomLocation.php",{cid:cid},e)},e.getCharacter=function(e){ajax("php/getCharacter.php",{cid:cid},function(t){e(new Character(t))})},e.getRoomEnemies=function(e){ajax("php/getRoomEnemies.php",{cid:cid},function(t){var n=(new Date).getTime();for(var r=0;r<t.length;r++)t[r]=new Character(t[r]),t[r].lastTime=n,t[r].elapsedTime=0;e(t)})},e.moveCharacter=function(e,t){var n={column:character.location.column,row:character.location.row};ajax("php/moveCharacter.php",{cid:cid,row:e.row,column:e.column},function(e){e||(character.tween.clear(),character.location.row=n.row,character.location.column=n.column),t()})},e.attack=function(e,n,r){var i=room.location.row*CONSTANTS.TILE.COLUMNS+room.location.column,o=e[n],u=o.location.row,a=o.location.column,f=0;r?f=Math.max(character.statistics.getCurrent("strength")-o.statistics.getCurrent("defense"),0):f=Math.max(character.statistics.getCurrent("intelligence")-o.statistics.getCurrent("resistance"),0),o.damage(f,function(){var e=t(a,u);character.statistics.experience.current+=this.statistics.experience.current,addBehavior("Kill",o.name),character.statistics.experience.current>=character.statistics.experience.max&&(alert("Level Up!"),character.level++,statisticsPoints+=5,character.statistics.health.max+=10,character.statistics.energy.max+=10,character.statistics.health.current=character.statistics.health.max,character.statistics.energy.current=character.statistics.energy.max,character.statistics.experience.max*=2),(s[i]=s[i]||[]).push(e),items.events.invoke("drop")},function(){e.splice(e.indexOf(o),1)})};var s=[];return e.getRoomItems=function(e){ajax("php/getItemsInRoom.php",{cid:cid},function(t){if(t)for(var n=0;n<t.length;n++)t[n]=new Item(t[n]);e(t||[])})},e.getSkills=function(e){ajax("php/getSkills.php",{cid:cid},e)},e.getBehaviors=function(){return{Kill:{Skeleton:0},Character:{Deaths:0,Steps:0,Attacks:0,"Seconds Played":0},Skill:{"Power Thrust":0,"Fire Wave":0,"Fire Arrow":0,Heal:0},Damage:{Dealt:0,Received:0},Discover:{Rooms:0,Maps:0}}},e.getBadges=function(){return[{name:"First Kill",category:"Kill",count:1,icon:loadImage("badges/death.png")},{name:"Killer",category:"Kill",count:50,icon:loadImage("badges/ddeath.png")},{name:"First Death",category:"Character",subcategory:"Deaths",count:1,icon:loadImage("badges/killed.png")},{name:"First Step",category:"Character",subcategory:"Steps",count:1,icon:loadImage("badges/arrow.png")},{name:"Adventurer",category:"Discover",subcategory:"Rooms",count:10,complete:1,icon:loadImage("badges/up.png")},{name:"Explorer",category:"Discover",subcategory:"Maps",count:1,icon:loadImage("badges/dup.png")},{name:"Skillful",category:"Skill",count:10,icon:loadImage("badges/tstar.png")}]},e}(),CONSTANTS={TILE:{WIDTH:48,HEIGHT:48,ROWS:7,COLUMNS:7,MIDDLE:{ROW:function(){return Math.floor(CONSTANTS.TILE.ROWS/2)},COLUMN:function(){return Math.floor(CONSTANTS.TILE.COLUMNS/2)}}},WIDTH:function(){return CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS},HEIGHT:function(){return CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS},WALL:{NONE:0,TOP:1,RIGHT:2,BOTTOM:4,LEFT:8,ALL:15},DIRECTION:{UP:0,RIGHT:3,DOWN:2,LEFT:1},INBETWEEN:function(){return canvas.width/2-(CONSTANTS.TILE.ROWS+2)*CONSTANTS.TILE.WIDTH/2-20},START:{X:function(){return canvas.width/2-CONSTANTS.WIDTH()/2},Y:function(){return canvas.height/2-CONSTANTS.HEIGHT()/2}},MAX_WEIGHT:4},tileset=new TileSet({columns:9,rows:16,src:"tiles.gif"}),statisticsPoints=0,skills=[],canvas,context,background=loadImage("background.jpg"),character={},contexts=[],room={location:{column:0,row:0},events:new EventHandler},items={list:[],events:new EventHandler},inventory_items=[],equipment_items={},enemies=[],behaviors=Server.getBehaviors(),badges=Server.getBadges();Server.getCharacterRoomLocation(function(e){room.location=e}),Server.getItemsInInventory(function(e){inventory_items=e;for(var t=0;t<e.length;t++)inventory_items[t]&&(inventory_items[t]=new Item(inventory_items[t]));unlock("inventory",1)}),Server.getCharacter(function(e){character=e,character.events=new EventHandler,unlock("character",5)}),Server.getSkills(function(e){var t=0,n,r;for(;t<e.length;t++){e[t].image.icon=loadImage(e[t].image.icon),r=e[t].add;for(n=0;n<r.length;n++)r[n]=new Statistics(r[n]);r=e[t].multiply;for(n=0;n<r.length;n++)r[n]=new Statistics(r[n])}skills=e,unlock("skills",1)});$(function(){function r(){requestAnimFrame(r),n();for(var t in e){var i=e[t];i.clearRect(0,0,i.canvas.width,i.canvas.height)}canvas.drawWith(0),background&&background.complete&&context.drawImage(background,0,0,canvas.width,canvas.height),canvas.events.invoke("draw")}function i(){Sound.effect("sound/scream/scream"+(1+Math.floor(Math.random()*5))),setTimeout(i,5e3+5e3*Math.random())}canvas={width:800,height:600},canvas.events=new EventHandler,canvas.drawWith=function(t){if(!e[t]){var n=document.createElement("canvas");n.width=canvas.width,n.height=canvas.height,n.style.zIndex=t,document.body.appendChild(n),e[t]=n.getContext("2d")}context=e[t],context.font="16px Sans-Serif"};var e=[];attachEvent(document,"click",function(e){var t=document.body.getBoundingClientRect();canvas.events.invoke("click",[{x:(e.pageX-t.left)*(canvas.width/document.body.clientWidth),y:(e.pageY-t.top)*(canvas.height/document.body.clientHeight)}])}),attachEvent(document,"mousemove",function(e){var t=document.body.getBoundingClientRect();canvas.events.invoke("mousemove",[{x:(e.pageX-t.left)*(canvas.width/document.body.clientWidth),y:(e.pageY-t.top)*(canvas.height/document.body.clientHeight)}])});var t=[];attachEvent(document,"keydown",function(e){t[e.which]||(canvas.events.invoke("keydown",e.which),t[e.which]=1),e.preventDefault()}),attachEvent(document,"keyup",function(e){canvas.events.invoke("keyup",e.which),t[e.which]=0,e.preventDefault()});var n=function(){window.setTimeout=function(e,r){if(r<=0)e();else if(Math.abs(r)!==1/0){var i=n;return n++,t[i]={f:e,t:r,r:r},i}return-1},window.setInterval=function(e,r){if(Math.abs(r)!==1/0){var i=n;return n++,t[i]={f:e,t:r,r:r,i:!0},i}return-1},window.setCatchup=function(e,r){if(Math.abs(r)!==1/0){var i=n++;return t[i]={f:e,t:r,r:r,i:!0,c:!0},i}return-1},window.clearTimeout=function(e){delete t[e]},window.clearInterval=function(e){delete t[e]};var e=new Date,t={},n=0;return function(){var n=new Date,r=n-e;e=n;for(var i in t)if(t.hasOwnProperty(i)&&(t[i].r-=r)<=0){var s=t[i].f;if(t[i].i)if(t[i].c)while(t[i]&&t[i].r<0)t[i].r+=t[i].t,s&&s();else t[i].r=t[i].t,s&&s();else s&&s(),delete t[i]}}}();canvas.padding=5,canvas.fontSize=function(){return parseInt(context.font,10)},r(),setInterval(function(){addBehavior("Character","Seconds Played")},1e3),i()});$(function(){var e=[];alert=function(t){e.unshift(t),setTimeout(function(){e.pop()},5e3)},canvas.events.attach("draw",function(){canvas.drawWith(1),context.fillStyle="white",context.textAlign="right",context.textBaseline="bottom";for(var t=Math.min(5,e.length)-1;t>=0;t--)context.fillText(e[t],canvas.width-5,canvas.height-12*t-5,CONSTANTS.INBETWEEN())})});$(function(){var e;room.events.attach("change",function(){e=Server.getTiles()}),canvas.events.attach("draw",function(){canvas.drawWith(2),context.strokeStyle="black";for(var t=0;t<CONSTANTS.TILE.ROWS;t++)for(var n=0;n<CONSTANTS.TILE.COLUMNS;n++){if(tileset.complete){var r=e[n][t],i=r.column*tileset.width,s=r.row*tileset.height,o=CONSTANTS.START.X()+n*CONSTANTS.TILE.WIDTH,u=CONSTANTS.START.Y()+t*CONSTANTS.TILE.HEIGHT;context.drawImage(tileset.image,i,s,tileset.width,tileset.height,o,u,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}context.strokeRect(CONSTANTS.START.X()+n*CONSTANTS.TILE.WIDTH,CONSTANTS.START.Y()+t*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}})});var Blood=function(){function e(e){var t=e.count||500,n=e.colors||s,r=e.speed||50,o=e.size||5;for(var u=0;u<t;u++){var a=2*Math.PI*Math.random(),f=Math.random()*r;i.push({color:n[Math.floor(n.length*Math.random())],size:Math.ceil(o*Math.random()),location:{x:e.location.x,y:e.location.y},velocity:{x:Math.cos(a)*f,y:Math.sin(a)*f},room:{column:room.location.column,row:room.location.row}})}}var t=[],n,r,i=[];$(function(){canvas.events.attach("draw",function(){canvas.drawWith(3);for(var e=i.length-1;e>=0;e--){var r=i[e],s=r.location,o=r.velocity;if(Math.abs(o.x)+Math.abs(o.y)<1||s.x<=CONSTANTS.START.X()||s.y<=CONSTANTS.START.Y()||s.x>=CONSTANTS.START.X()+n.width||s.y>=CONSTANTS.START.Y()+n.height){i.splice(e,1);var u=t[r.room.row][r.room.column].getContext("2d");u.fillStyle=r.color,u.fillRect(s.x-CONSTANTS.START.X(),s.y-CONSTANTS.START.Y(),r.size,r.size)}else r.room.column===room.location.column&&r.room.row===room.location.row&&(context.fillStyle=r.color,context.fillRect(s.x,s.y,r.size,r.size)),s.x+=o.x,s.y+=o.y,o.x/=2,o.y/=2}context.drawImage(n,CONSTANTS.START.X(),CONSTANTS.START.Y())}),room.events.attach("change",function(){var e=t[room.location.row]=t[room.location.row]||[],i=e[room.location.column];i||(i=document.createElement("canvas"),i.width=CONSTANTS.TILE.WIDTH*CONSTANTS.TILE.COLUMNS,i.height=CONSTANTS.TILE.HEIGHT*CONSTANTS.TILE.ROWS),e[room.location.column]=n=i,r=i.getContext("2d")})});var s=["rgba(102, 000, 000, 0.30)","rgba(220, 020, 060, 0.30)","rgba(139, 000, 000, 0.30)","rgba(128, 000, 000, 0.30)","rgba(255, 255, 255, 0.30)","rgba(204, 017, 000, 0.30)"];return e}();$(function(){var e=0;items.events.attach("drop",function(){Server.getRoomItems(function(t){items.list=t;while(e<t.length){var n=t[e].sounds.move;Sound.effect(n[Math.floor(Math.random()*n.length)]),e++}})}),room.events.attach("change",function(){Server.getRoomItems(function(t){items.list=t,e=t.length})}),canvas.events.attach("draw",function(){canvas.drawWith(4);for(var e=items.list.length-1;e>=0;e--){var t=items.list[e],n=t.location,r=CONSTANTS.START,i=CONSTANTS.TILE;context.drawImage(items.list[e].portrait,r.X()+n.column*i.WIDTH,r.Y()+n.row*i.HEIGHT,i.WIDTH,i.HEIGHT)}})});$(function(){lock("character",function(){function n(){Server.moveEnemies(function(e){var t=1/0,r=e.enemies;if(r){for(var i=0;i<r.length;i++){var s=r[i];for(var o=0;o<enemies.length;o++){var u=enemies[o];if(u.statistics.getCurrent("health")>0&&u.id===s.id){u.tween.clear();if(s.column===s.lastColumn&&s.row===s.lastRow)u.face(character.location.column,character.location.row),u.attack();else{var a=CONSTANTS.TILE.WIDTH*(s.column-s.lastColumn),f=CONSTANTS.TILE.HEIGHT*(s.row-s.lastRow);u.face(s.column,s.row),u.location.row=s.row,u.location.column=s.column,u.moveBy(a,f,function(){u.face(character.location.column,character.location.row)})}}}}character.damage(character.statistics.getCurrent("health")-e.character.health)}setTimeout(n,1e3)})}var e=canvas.width/2-CONSTANTS.WIDTH()/2,t=canvas.height/2-CONSTANTS.HEIGHT()/2;canvas.events.attach("draw",function(){canvas.drawWith(5);for(var e=0;e<enemies.length;e++)enemies[e].draw(context)}),room.events.attach("change",function(){Server.getRoomEnemies(function(e){enemies=e})}),character.events.attach("trymove",function(e){for(var t=0;t<enemies.length;t++){var n=enemies[t];e.row===n.location.row&&e.column===n.location.column&&n.statistics.health.current>0&&(e.collides=!0)}}),n()})});$(function(){function n(){var n=canvas.width/2-CONSTANTS.WIDTH()/2-CONSTANTS.TILE.WIDTH,r=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,i=Math.floor((CONSTANTS.TILE.ROWS+2)/2);for(var s=0;s<CONSTANTS.TILE.ROWS+2;s++)(s!==i||e&CONSTANTS.WALL.LEFT)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n,r+s*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT),(s!==i||e&CONSTANTS.WALL.RIGHT)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+CONSTANTS.WIDTH()+CONSTANTS.TILE.WIDTH,r+s*CONSTANTS.TILE.HEIGHT,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}function r(){var n=canvas.width/2-CONSTANTS.WIDTH()/2,r=canvas.height/2-CONSTANTS.HEIGHT()/2-CONSTANTS.TILE.HEIGHT,i=Math.floor(CONSTANTS.TILE.COLUMNS/2);for(var s=0;s<CONSTANTS.TILE.COLUMNS;s++)(s!==i||e&CONSTANTS.WALL.TOP)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+s*CONSTANTS.TILE.WIDTH,r,CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT),(s!==i||e&CONSTANTS.WALL.BOTTOM)&&context.drawImage(tileset.image,tileset.width*t.column,tileset.height*t.row,tileset.width,tileset.height,n+s*CONSTANTS.TILE.WIDTH,r+CONSTANTS.TILE.HEIGHT+CONSTANTS.HEIGHT(),CONSTANTS.TILE.WIDTH,CONSTANTS.TILE.HEIGHT)}var e,t={column:6,row:11};room.events.attach("change",function(){Server.getWalls(function(t){e=t})}),lock("character",function(){character.events.attach("trymove",function(t){var n=CONSTANTS.TILE.MIDDLE.ROW(),r=CONSTANTS.TILE.MIDDLE.COLUMN();t.collides=t.collides||t.column===-1&&t.row===n&&e&CONSTANTS.WALL.LEFT||t.column===-1&&t.row!==n,t.collides=t.collides||t.column===CONSTANTS.TILE.COLUMNS&&t.row===n&&e&CONSTANTS.WALL.RIGHT||t.column===CONSTANTS.TILE.COLUMNS&&t.row!==n,t.collides=t.collides||t.row===-1&&t.column===r&&e&CONSTANTS.WALL.TOP||t.row===-1&&t.column!==r,t.collides=t.collides||t.row===CONSTANTS.TILE.ROWS&&t.column===r&&e&CONSTANTS.WALL.BOTTOM||t.row===CONSTANTS.TILE.ROWS&&t.column!==r})}),canvas.events.attach("draw",function(){canvas.drawWith(6),n(),r()})});$(function(){var e={data:[],columns:0,rows:0},t=0;Server.getAllWalls(function(t){e=t,room.events.invoke("change")}),setInterval(function(){t+=Math.PI/10,t%=2*Math.PI},100),canvas.events.attach("draw",function(){canvas.drawWith(7),context.save(),context.translate(canvas.width-CONSTANTS.INBETWEEN()-10,10),context.strokeStyle="black",context.fillStyle="rgba(255, 255, 255, 0.5)",context.fillRect(0,0,CONSTANTS.INBETWEEN(),CONSTANTS.INBETWEEN());var n=CONSTANTS.INBETWEEN()/e.columns,r=CONSTANTS.INBETWEEN()/e.rows;for(var i=0;i<e.data.length;i++){var s=e.data[i],o=i%e.columns,u=Math.floor(i/e.rows);s!==null&&context.fillRect(n*o,r*u,n,r),s&CONSTANTS.WALL.TOP&&context.strokeRect(n*o,r*u,n,1),s&CONSTANTS.WALL.RIGHT&&context.strokeRect(n*o+n,r*u,1,r),s&CONSTANTS.WALL.BOTTOM&&context.strokeRect(n*o,r*u+r,n,1),s&CONSTANTS.WALL.LEFT&&context.strokeRect(n*o,r*u,1,r)}var a=n/4,f=r/4;context.fillStyle="rgba(255, 0, 0, "+((1+Math.sin(t))/4+.5)+")",context.fillRect(room.location.column*n+n/2-a/2,room.location.row*r+r/2-f/2,a-1,f-1),context.restore()}),room.events.attach("change",function(){e.data[room.location.column+room.location.row*e.columns]||Server.getWalls(function(t){e.data[room.location.column+room.location.row*e.columns]=t,addBehavior("Discover","Rooms")});for(var t=0;t<e.columns*e.rows;t++)if(!e.data[t])return;e.data.length&&addBehavior("Discover","Maps")}).invoke("change")});$(function(){lock("character",function(){canvas.events.attach("draw",function(){canvas.drawWith(8),character.draw(context)}),setCatchup(function(){character.statistics.getCurrent("energy")<character.statistics.getMax("energy")&&(Server.healEnergy(),character.statistics.energy.current++)},1e3),canvas.events.attach("keydown",function(e){if(character.tween.isTweening()||character.statistics.getCurrent("health")<=0)return;var t=1,n={column:character.location.column,row:character.location.row,collides:!1},r=0,i=0;e===37?(n.column--,character.display.row=CONSTANTS.DIRECTION.LEFT,r=-CONSTANTS.TILE.WIDTH):e===38?(n.row--,character.display.row=CONSTANTS.DIRECTION.UP,i=-CONSTANTS.TILE.HEIGHT):e===39?(n.column++,character.display.row=CONSTANTS.DIRECTION.RIGHT,r=CONSTANTS.TILE.WIDTH):e===40?(n.row++,character.display.row=CONSTANTS.DIRECTION.DOWN,i=CONSTANTS.TILE.HEIGHT):(t=0,e===32&&(Server.sendDamage(""),addBehavior("Character","Attacks"),character.attack()));if(t){character.events.invoke("trymove",n);if(!n.collides){var s=!0;n.column===-1?room.location.column--:n.column===CONSTANTS.TILE.COLUMNS?room.location.column++:n.row===-1?room.location.row--:n.row===CONSTANTS.TILE.ROWS?room.location.row++:s=!1,Server.moveCharacter(n,function(){s&&room.events.invoke("change")}),character.location.column=(n.column+CONSTANTS.TILE.COLUMNS)%CONSTANTS.TILE.COLUMNS,character.location.row=(n.row+CONSTANTS.TILE.ROWS)%CONSTANTS.TILE.ROWS,addBehavior("Character","Steps"),s||character.moveBy(r,i)}}})})});$(function(){lock("character",function(){function i(e,t,i,s,o,u){u=Math.min(Math.max(0,u),1),context.fillStyle=e;var a=s/r.width,f=o/r.height;context.drawImage(r,t,i,s,o),context.fillRect(t+12*a,i+8*f,(s-24*a)*u,15*f),context.drawImage(n,t,i,s,o)}var e=canvas.width/2-CONSTANTS.WIDTH()/2,t=canvas.height/2-CONSTANTS.HEIGHT()/2,n=loadImage("health/foreground_gray.png"),r=loadImage("health/background.png");canvas.events.attach("draw",function(){canvas.drawWith(9);var n=character.statistics.getCurrent("health")/character.statistics.getMax("health"),r=character.statistics.getCurrent("energy")/character.statistics.getMax("energy"),s=character.statistics.getCurrent("experience")/character.statistics.getMax("experience");i("red",10,t-CONSTANTS.TILE.HEIGHT,CONSTANTS.INBETWEEN(),25,n),i("blue",10,t-CONSTANTS.TILE.HEIGHT+35,CONSTANTS.INBETWEEN(),25,r),i("green",10,t-CONSTANTS.TILE.HEIGHT+70,CONSTANTS.INBETWEEN(),25,s);for(var o=0;o<enemies.length;o++){var u=enemies[o].location,a=enemies[o].statistics,f=a.getCurrent("health");f>0&&i("red",e+5+u.column*CONSTANTS.TILE.WIDTH+u.x,t+u.row*CONSTANTS.TILE.HEIGHT+u.y,CONSTANTS.TILE.WIDTH-10,10,f/a.getMax("health"))}})})});$(function(){lock("inventory",function(){canvas.events.attach("keydown",function(e){if(e===17){var t=inventory_items.indexOf(null);for(var n=0;n<items.list.length;n++){var r=items.list[n];if(r.location.column===character.location.column&&r.location.row===character.location.row){if(t!==-1){Server.pickupItem(function(e){e&&(inventory_items[t]=r,Sound.effect(r.sounds.move),items.list.splice(n,1))});break}alert("You have no room in your inventory for that item.")}}}e===73?inventory_items.visible=!inventory_items.visible:inventory_items.visible=0});var e={x:0,y:100},t=CONSTANTS.TILE.WIDTH,n=CONSTANTS.TILE.HEIGHT,r=4,i=6,s,o=(t+canvas.padding*2)*i,u=canvas.padding*2+canvas.padding*2+canvas.fontSize()+(n+canvas.padding*2)*r;inventory_items.visible=0,loadImage("window/texture.png",function(e){s=context.createPattern(e,"repeat")});var a={"Equip / Use":function(e){var t=inventory_items.indexOf(e),n=inventory_items.indexOf(null),r,i=e.type;Server.equipItem(e.id,function(r){if(r){if(e.type==="mainhand"){if(e.weight===1)equipment_items.mainhand.item&&equipment_items.mainhand.item.weight===3?unequip("mainhand",t):unequip("offhand",t),i="offhand";else if(e.weight===2)unequip("mainhand",t);else if(e.weight===3){if(!!equipment_items.offhand.item&&n===-1){alert("You have no room in your inventory for your equipped items.");return}unequip("mainhand",t),equipment_items.offhand.item&&unequip("offhand",n)}}else unequip(e.type,t);equip(e,i)}})},Drop:function(e){inventory_items[inventory_items.indexOf(e)]=null,e.location.row=character.location.row,e.location.column=character.location.column,items.list.push(e),Sound.effect(e.sounds.move)},Destroy:function(e){inventory_items[inventory_items.indexOf(e)]=null,Sound.effect(e.sounds.move)}};for(var f=0;f<r;f++)for(var l=0;l<i;l++){var c=canvas.padding+(canvas.padding*2+t)*l,h=canvas.padding*3+canvas.padding*2+canvas.fontSize()+(canvas.padding*2+n)*f;contexts.push({column:l,row:f,x:c,y:h,width:t,height:n,contains:function(t){if(inventory_items.visible){var n=this.x+e.x,r=this.y+e.y,s=n+this.width,o=r+this.height;if(t.x>=n&&t.y>=r&&t.x<=s&&t.y<=o){var u=inventory_items[this.column+this.row*i];if(u)return{context:u,menu:a}}}}})}canvas.events.attach("draw",function(){canvas.drawWith(10);if(inventory_items.visible){e.x=canvas.width/2-o/2,e.y=canvas.height/2-u/2,context.save(),context.globalAlpha=.8,context.translate(e.x,e.y),context.strokeStyle="black",context.fillStyle=s,context.fillRect(0,0,o,u),context.strokeRect(0,0,o,u),context.strokeRect(canvas.padding,canvas.padding,o-canvas.padding*2,canvas.padding*2+canvas.fontSize());for(var a=0;a<r;a++)for(var f=0;f<i;f++){var l=canvas.padding+(canvas.padding*2+t)*f,c=canvas.padding*3+canvas.padding*2+canvas.fontSize()+(canvas.padding*2+n)*a,h=inventory_items[f+a*i];context.strokeRect(l,c,t,n),h&&context.drawImage(h.portrait,l,c,t,n)}context.strokeStyle="white",context.textBaseline="middle",context.textAlign="left",context.fillStyle="white",context.fillText("Inventory",canvas.padding*2,canvas.padding*2+canvas.fontSize()/2,o-canvas.padding*2),context.restore()}})})});$(function(){var e=296,t=330,n,r={x:400,y:0};equipment_items.visible=0,loadImage("window/texture.png",function(e){n=context.createPattern(e,"repeat")}),equipment_items.head={rectangle:{x:e/2-32,y:canvas.padding*3+canvas.padding*2+canvas.fontSize(),width:64,height:64},empty:loadImage("items/head.png")},equipment_items.neck={rectangle:{x:e/2-64-canvas.padding*2,y:canvas.padding*3+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height-32,width:32,height:32},empty:loadImage("items/neck.png")},equipment_items.chest={rectangle:{x:e/2-48,y:canvas.padding*5+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height,width:96,height:86},empty:loadImage("items/chest.png")},equipment_items.mainhand={rectangle:{x:canvas.padding,y:canvas.padding*5+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/mainhand.png")},equipment_items.offhand={rectangle:{x:e-canvas.padding-80,y:canvas.padding*5+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height,width:80,height:86},empty:loadImage("items/offhand.png")},equipment_items.legs={rectangle:{x:e/2-56,y:canvas.padding*7+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:112,height:112},empty:loadImage("items/legs.png")},equipment_items.feet={rectangle:{x:canvas.padding,y:canvas.padding*7+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/feet.png")},equipment_items.hands={rectangle:{x:e-72-canvas.padding,y:canvas.padding*7+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height,width:72,height:72},empty:loadImage("items/hands.png")},equipment_items.rightring={rectangle:{x:e/2+canvas.padding*3+equipment_items.legs.rectangle.width/2,y:canvas.padding*9+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")},equipment_items.leftring={rectangle:{x:e/2-canvas.padding*3-equipment_items.legs.rectangle.width/2-30,y:canvas.padding*9+canvas.padding*2+canvas.fontSize()+equipment_items.head.rectangle.height+equipment_items.chest.rectangle.height+equipment_items.hands.rectangle.height,width:30,height:30},empty:loadImage("items/ring.png")};var i={Unequip:function(e){Server.equipItem(e.item.id,function(t){if(t){var n=e.item.type;e===equipment_items.offhand&&(n="offhand"),unequip(n,inventory_items.indexOf(null))}})}};for(var s in equipment_items)contexts.push({item:equipment_items[s],contains:function(e){var t=this.item;if(equipment_items.visible&&t.item){var n=r.x+t.rectangle.x,s=r.y+t.rectangle.y,o=s+t.rectangle.height,u=n+t.rectangle.width;if(e.x>=n&&e.y>=s&&e.x<=u&&e.y<=o)return{context:t,menu:i}}}});canvas.events.attach("keydown",function(e){e===69?equipment_items.visible=!equipment_items.visible:equipment_items.visible=0}),canvas.events.attach("draw",function(){canvas.drawWith(11);if(equipment_items.visible){r.x=canvas.width/2-e/2,r.y=canvas.height/2-t/2,context.save(),context.globalAlpha=.8,context.translate(r.x,r.y),context.strokeStyle="black",context.fillStyle=n,context.fillRect(0,0,e,t),context.strokeRect(canvas.padding,canvas.padding,e-canvas.padding*2,canvas.padding*2+canvas.fontSize()),context.strokeRect(0,0,e,t);for(var i in equipment_items){var s=equipment_items[i],o=s.rectangle,u=s.empty,a=s.item;o&&(a?context.drawImage(a.portrait,o.x,o.y,o.width,o.height):u.complete&&context.drawImage(u,o.x,o.y,o.width,o.height),context.strokeRect(o.x,o.y,o.width,o.height))}context.strokeStyle="white",context.textAlign="left",context.textBaseline="middle",context.fillStyle="white",context.strokeText("Equipment",canvas.padding+5,canvas.padding+(canvas.padding*2+canvas.fontSize())/2,e),context.restore()}}),lock("character",function(){Server.getEquipment(function(e){for(var t=0;t<e.length;t++){var n=new Item(e[t]),r=n.type;n.type==="mainhand"&&n.weight===1&&(r="offhand"),equip(n,r)}})})});$(function(){function i(e){var t=o[(e+9)%10],n;t&&t.type==="active"&&!character.tween.isTweening()&&(t.isCool?equipment_items.mainhand.item&&equipment_items.mainhand.item.attack===t.action||t.action===null?character.statistics.getCurrent("energy")>=t.energy?Server.sendDamage((e+9)%10,function(){addBehavior("Skill",t.name),character.statistics.energy.current-=t.energy,character.attack(t.action||"spellcast");for(n=0;n<t.add.length;n++)character.statistics.add(t.add[n],!0);for(n=0;n<t.multiply.length;n++)character.statistics.multiply(t.multiply[n]);t.area>0?sendDamage(character.getDirection(),t):t.area<0&&(sendDamage({column:1,row:0},t),sendDamage({column:-1,row:0},t),sendDamage({column:0,row:1},t),sendDamage({column:0,row:-1},t)),t.lastUse=(new Date).getTime(),t.isCool=!1;for(n=0;n<t.add.length;n++)s(t.add[n]);for(n=0;n<t.multiply.length;n++)s(multiply.add[n])}):alert("Not enough energy."):alert("That weapon cannot be used for this skill."):alert("That skill is still cooling off."))}function s(e){setTimeout(function(){character.statistics.remove(e)},e.duration)}function d(e,n,r){var i=150,s=generateText({text:e.name+"\n"+e.description,color:"white",width:i-2*canvas.padding,font:context.font}),o=s.height;context.save(),context.globalAlpha=.8,n=Math.min(t.x-n,canvas.width-i),r=Math.min(t.y-r,canvas.height-o),context.fillRect(n,r,i,o+canvas.padding*2),context.strokeRect(n,r,i,o+canvas.padding*2),context.drawImage(s,n+canvas.padding,r+canvas.padding),context.restore()}function v(e,t,n){context.drawImage(e.image.icon,t,n,u,a),e.isCool=e.lastUse+e.cooldown<=(new Date).getTime();if(!e.isCool){context.save(),context.beginPath(),context.rect(t,n,u,a),context.clip(),context.closePath();var r=u/2,i=a/2,s=(new Date).getTime(),o=Math.sqrt(r*r+i*i),f=(s-e.lastUse)/e.cooldown;context.beginPath(),context.moveTo(t+r,n+i),context.lineTo(t+r,n),context.arc(t+r,n+i,o,-Math.PI/2,-Math.PI/2+2*Math.PI*f,!0),context.globalAlpha=.8,context.fill(),context.closePath(),context.restore()}context.strokeRect(t,n,u,a)}skills.visible=0;var e,t={x:0,y:0},n,r=skills[0];loadImage("window/texture.png",function(t){e=context.createPattern(t,"repeat")}),canvas.events.attach("keydown",function(e){var t=parseInt(String.fromCharCode(e),10);skills.visible||i(t),skills.visible&&r&&!isNaN(t)&&r.isCool?Server.setSkillIndex(r.id,t,function(){for(var e in o){var n=o[e];if(n&&n.id===r.id){delete o[e];break}}o[(t+9)%10]=r}):e===82?skills.visible=!skills.visible:skills.visible=0});var o=[];lock("skills",function(){Server.getSkillMapping(function(e){o=e})}),canvas.events.attach("mousemove",function(e){t=e}),canvas.events.attach("click",function(e){n=e});var u=CONSTANTS.TILE.WIDTH,a=CONSTANTS.TILE.HEIGHT,f=4,l=6,c=(u+canvas.padding*2)*l,h=canvas.padding*2+canvas.padding*2+canvas.fontSize()+(a+canvas.padding*2)*f,p={x:canvas.width/2-c/2,y:canvas.height/2-h/2};inventory_items.visible=0,canvas.events.attach("draw",function(){canvas.drawWith(12),context.fillStyle="gray",e&&(context.fillStyle=e);var i=0,s,m,g,y,b,w;if(skills.visible){context.save(),context.translate(p.x,p.y),context.globalAlpha=.8,context.strokeStyle="black",context.fillRect(0,0,c,h),context.strokeRect(0,0,c,h),context.strokeRect(canvas.padding,canvas.padding,c-canvas.padding*2,canvas.padding*2+canvas.fontSize());for(m=0;m<f;m++)for(b=0;b<l;b++,i++)g=canvas.padding+b*(u+canvas.padding*2),y=3*canvas.padding+canvas.padding*2+canvas.fontSize()+m*(a+canvas.padding*2),r&&skills[i]&&r===skills[i]?(context.strokeStyle="yellow",context.strokeRect(g,y,u,a),context.strokeStyle="black"):context.strokeRect(g,y,u,a),i<skills.length&&(w=skills[i],v(w,g,y),t.x>=p.x+g&&t.y>=p.y+y&&t.x<=p.x+g+u&&t.y<=p.y+y+a&&(s={x:p.x,y:p.y,skill:w}),n&&n.x>=p.x+g&&n.y>=p.y+y&&n.x<=p.x+g+u&&n.y<=p.y+y+a&&(r=w));s&&d(s.skill,s.x,s.y),context.strokeStyle="white",context.textBaseline="middle",context.textAlign="left",context.fillStyle="white",context.fillText("Skills",canvas.padding*2,canvas.padding*2+canvas.fontSize()/2,c-canvas.padding*2),context.globalAlpha=1,context.restore()}context.strokeStyle="black",s=0;for(m=0;m<10;m++)g=m*u+canvas.padding+m*canvas.padding,y=canvas.height-a-canvas.padding,context.fillRect(g,y,u,a),o[m]&&(v(o[m],g,y),t&&t.x>=g&&t.y>=y&&t.x<=g+u&&t.y<=y+a&&(s={x:0,y:0,skill:o[m]})),context.strokeRect(g,y,u,a);s&&d(s.skill,s.x,s.y),n=0})});$(function(){function a(t){if(t){var r,i=e;if(equipment_items.visible)t=t.item;else{var u=t.type;u==="mainhand"&&t.weight===1&&(!equipment_items.mainhand.item||equipment_items.mainhand.item.weight!==4)&&(u="offhand"),r=equipment_items[u].item,r&&(i*=2)}context.save(),context.translate(clamp(o.x,0,canvas.width-i),clamp(o.y,0,canvas.height-s)),context.strokeStyle="black",context.fillStyle=n,context.fillRect(0,0,i,s),context.strokeRect(0,0,i,s),c(t,"Item"),r&&(context.translate(e,0),c(r,"Equipped")),context.restore()}}function f(){for(var e=0;e<contexts.length;e++){var t=contexts[e].contains(o);if(t)return t.context}return!1}function l(){t.x=canvas.width/2-e/2,t.y=canvas.height/2-s/2,context.save(),context.translate(t.x,t.y),context.strokeStyle="black",context.fillStyle=n,context.fillRect(0,0,e,s),context.strokeRect(0,0,e,s),c(character,"Character"),context.restore()}function c(t,n){context.strokeRect(canvas.padding,canvas.padding,e-canvas.padding*2,canvas.padding*2+canvas.fontSize());var i=e/2,s=i;context.strokeRect(canvas.padding,canvas.padding*3+canvas.padding*2+canvas.fontSize(),i-canvas.padding*2,s-canvas.padding*2),context.strokeRect(e-i+canvas.padding,canvas.padding*3+canvas.padding*2+canvas.fontSize(),i-canvas.padding*2,s-canvas.padding*2),t.portrait.complete&&context.drawImage(t.portrait,e-i+canvas.padding,canvas.padding*3+canvas.padding*2+canvas.fontSize(),i-canvas.padding*2,i-canvas.padding*2),context.fillStyle="white",context.textAlign="right",context.textBaseline="bottom",context.fillText(t.name,i-canvas.padding*2,canvas.padding*2+canvas.fontSize()+s,i),context.textBaseline="middle",i=e/3;for(var o=0;o<r.length;o++){context.textAlign="right";var u=canvas.padding+canvas.padding+canvas.fontSize()+canvas.padding+canvas.padding+canvas.padding+s+canvas.padding+canvas.fontSize()/2+o*(canvas.padding*4+canvas.fontSize());context.fillText(r[o][0].toUpperCase()+r[o].substring(1),i-canvas.padding*2,u,e),context.strokeRect(canvas.padding,canvas.padding*2+canvas.fontSize()+canvas.padding*3+s+o*(canvas.padding*2+canvas.padding*2+canvas.fontSize()),i-canvas.padding*2,canvas.padding*2+canvas.fontSize()),context.textAlign="center",context.fillText(t.statistics.getMax(r[o]),i+i/2,u,i-canvas.padding*2),context.strokeRect(canvas.padding+i,canvas.padding*2+canvas.fontSize()+canvas.padding*3+s+o*(canvas.padding*2+canvas.padding*2+canvas.fontSize()),i-canvas.padding*2,canvas.padding*2+canvas.fontSize()),context.fillText(t.statistics.getCurrent(r[o]),2*i+i/2,u,i-canvas.padding*2),context.strokeRect(canvas.padding+2*i,canvas.padding*2+canvas.fontSize()+canvas.padding*3+s+o*(canvas.padding*2+canvas.padding*2+canvas.fontSize()),i-canvas.padding*2,canvas.padding*2+canvas.fontSize())}context.textAlign="left",context.fillText(n+" Statistics",canvas.padding*2,canvas.padding*2+canvas.fontSize()/2,e)}var e=300,t={x:0,y:0},n,r=Statistics.getStatisticNames(),i=0,s=canvas.padding*2+canvas.fontSize()+canvas.padding*2+e/2+r.length*(canvas.padding*2+canvas.padding*2+canvas.fontSize()),o={x:0,y:0},u=0;loadImage("window/texture.png",function(e){n=context.createPattern(e,"repeat")}),canvas.events.attach("mousemove",function(e){o=e,u=1}),canvas.events.attach("keydown",function(e){e===67?i=!i:i=0,u=0}),canvas.events.attach("draw",function(){canvas.drawWith(13),context.save(),context.globalAlpha=.8;if(i)l();else if(!contexts.contextmenu&&u){a(f());if(!equipment_items.visible&&!inventory_items.visible&&!skills.visible&&!behaviors.visible&&!badges.visible){var e=Math.floor((o.x-CONSTANTS.START.X())/CONSTANTS.TILE.WIDTH),t=Math.floor((o.y-CONSTANTS.START.Y())/CONSTANTS.TILE.HEIGHT);for(var n=0;n<items.list.length;n++){var r=items.list[n],s=r.location;if(s.column===e&&s.row===t){a(r);break}}}}context.restore()})});$(function(){var e,t,n=canvas.padding*2+canvas.fontSize(),r,i,s;canvas.events.attach("click",function(n){if(e){var r=Object.keys(e.menu);e.menu[r[s]](e.context),contexts.contextmenu=e=0}else{s=0,e=0,t=n;for(var i=0;i<contexts.length&&!e;i++)e=contexts[i].contains(n);contexts.contextmenu=e,t.x-=5,t.y-=5}}),canvas.events.attach("keydown",function(){contexts.contextmenu=e=0}),canvas.events.attach("mousemove",function(o){e&&(o.x<t.x||o.y<t.y||o.x>=t.x+i||o.y>=t.y+r)?contexts.contextmenu=e=0:e&&(s=Math.floor((o.y-t.y)/n))}),canvas.events.attach("draw",function(){canvas.drawWith(14);if(e){var o=Object.keys(e.menu),u=0,a;for(a=0;a<o.length;a++)i=context.measureText(o[a]).width,i>u&&(u=i);r=n*o.length,context.fillStyle="gray",context.strokeStyle="black",context.textBaseline="middle",context.textAlign="left",u+=canvas.padding*2,i=u,context.fillRect(t.x,t.y,u,r),context.fillStyle="lightgray",context.fillRect(t.x,t.y+n*s,i,n);for(a=0;a<o.length;a++)context.strokeText(o[a],t.x+canvas.padding,t.y+(a+1)*n-n/2,u)}})});$(function(){var e=["Strength","Defense","Intelligence","Resistance","Speed"],t=CONSTANTS.INBETWEEN(),n=(canvas.fontSize()+canvas.padding*4)*(e.length+1),r=10,i=canvas.height-n-CONSTANTS.TILE.HEIGHT-20,s,o;loadImage("window/texture.png",function(e){s=context.createPattern(e,"repeat")}),canvas.events.attach("click",function(e){o=e}),canvas.events.attach("draw",function(){canvas.drawWith(15);if(statisticsPoints>0){context.fillStyle="gray",context.strokeStyle="black",s&&(context.fillStyle=s),context.fillRect(r,i,t,n),context.strokeRect(r,i,t,n),context.textAlign="center",context.textBaseline="middle";var u=r+canvas.padding,a=i+canvas.padding,f=t-canvas.padding*2,l=canvas.fontSize()+canvas.padding*2;context.strokeRect(u,a,f,l),context.strokeText(statisticsPoints+"SP To Spend",u+f/2,a+l/2);for(var c=0;c<e.length;c++)u=r+canvas.padding,a=i+(canvas.fontSize()+canvas.padding*4)*(c+1)+canvas.padding,context.strokeRect(u,a,f,l),context.strokeText(e[c],u+f/2,a+l/2),o&&o.x>=u&&o.y>=a&&o.x<=u+f&&o.y<=a+l&&(character.statistics[e[c].toLowerCase()].current++,character.statistics[e[c].toLowerCase()].max++,statisticsPoints--);o=0}})});function addBehavior(e,t,n){behaviors[e][t]+=n||1;for(var r=0;r<badges.length;r++){var i=badges[r];if(!i.complete){var s=i.category,o=i.subcategory,u=0;if(!o)for(var a in behaviors[s])u+=behaviors[s][a];else u=behaviors[s][o];u>=i.count&&(i.complete=1,alert(i.name+" earned."))}}}$(function(){var e=200,t=400,n=canvas.width/2-e/2,r=canvas.height/2-t/2,i;loadImage("window/texture.png",function(e){i=context.createPattern(e,"repeat")}),canvas.events.attach("keydown",function(e){e===71?behaviors.visible=1:behaviors.visible=0}),canvas.events.attach("draw",function(){canvas.drawWith(16);if(behaviors.visible){context.globalAlpha=.8,context.strokeStyle="black",context.fillStyle="gray",i&&(context.fillStyle=i),context.fillRect(n,r,e,t),context.strokeRect(n,r,e,t),context.strokeRect(n+canvas.padding,r+canvas.padding,e-canvas.padding*2,canvas.fontSize()+2*canvas.padding),context.strokeStyle="white",context.textAlign="left",context.textBaseline="middle",context.strokeText("General Statistics",n+canvas.padding*2,r+canvas.padding+(canvas.fontSize()+2*canvas.padding)/2);var s="";for(var o in behaviors)if(behaviors[o]instanceof Object){s&&(s+="\n"),s+=o;for(var u in behaviors[o])s+="\n    "+u+" : "+behaviors[o][u]}s=generateText({text:s,width:e-canvas.padding*2,color:"white",font:context.font}),context.drawImage(s,n+canvas.padding,r+canvas.padding*4+canvas.fontSize()),context.globalAlpha=1}})});$(function(){function f(e,n,r){var i=150,s=generateText({text:e.name+"\n"+e.category+" "+(e.subcategory||"")+" "+e.count,font:context.font,color:"white",width:i-canvas.padding*2}),o=s.height;context.save(),context.globalAlpha=.8,n=Math.min(t.x-n,canvas.width-i),r=Math.min(t.y-r,canvas.height-o),context.fillRect(n,r,i,o+canvas.padding*2),context.strokeRect(n,r,i,o+canvas.padding*2),context.drawImage(s,n+canvas.padding,r+canvas.padding),context.restore()}function l(e,t,i){e.icon.complete&&context.drawImage(e.icon,t,i,n,r),e.complete||context.fillRect(t,i,n,r),context.strokeRect(t,i,n,r)}badges.visible=0;var e,t={x:0,y:0};loadImage("window/texture.png",function(t){e=context.createPattern(t,"repeat")}),canvas.events.attach("keydown",function(e){e===66?badges.visible=!badges.visible:badges.visible=0}),canvas.events.attach("mousemove",function(e){t=e});var n=CONSTANTS.TILE.WIDTH,r=CONSTANTS.TILE.HEIGHT,i=4,s=6,o=(n+canvas.padding*2)*s,u=canvas.padding*2+(canvas.padding*2+canvas.fontSize())+(r+canvas.padding*2)*i,a={x:canvas.width/2-o/2,y:canvas.height/2-u/2};inventory_items.visible=0,canvas.events.attach("draw",function(){canvas.drawWith(17);var c=0,h,p,d,v,m,g;context.fillStyle="gray",e&&(context.fillStyle=e);if(badges.visible){context.save(),context.translate(a.x,a.y),context.globalAlpha=.8,context.strokeStyle="black",context.fillRect(0,0,o,u),context.strokeRect(0,0,o,u),context.strokeRect(canvas.padding,canvas.padding,o-canvas.padding*2,canvas.padding*2+canvas.fontSize());for(p=0;p<i;p++)for(m=0;m<s;m++,c++)d=canvas.padding+m*(n+canvas.padding*2),v=3*canvas.padding+(canvas.padding*2+canvas.fontSize())+p*(r+canvas.padding*2),context.strokeRect(d,v,n,r),c<badges.length&&(g=badges[c],l(g,d,v),t.x>=a.x+d&&t.y>=a.y+v&&t.x<=a.x+d+n&&t.y<=a.y+v+r&&(h={x:a.x,y:a.y,badge:g}));h&&f(h.badge,h.x,h.y),context.strokeStyle="white",context.textBaseline="middle",context.textAlign="left",context.fillStyle="white",context.fillText("Badges",canvas.padding*2,canvas.padding+(canvas.padding*2+canvas.fontSize())/2,o-canvas.padding*2),context.globalAlpha=1,context.restore()}})});